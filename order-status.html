<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Order Status - Bake & Grill</title>
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="/site.webmanifest.json">
  <meta name="theme-color" content="#e63946">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  
  <!-- CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mobile-view">
  
  <header class="mobile-header">
    <div class="logo-container">
      <a href="index.html" class="back-button"><i class="fas fa-arrow-left"></i></a>
      <div class="logo">Order Status</div>
      <div class="mobile-cart-icon" id="mobileCartBtn">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge">0</span>
      </div>
    </div>
  </header>

  <div class="mobile-container">
    <div id="orderStatusContainer" class="order-status-container">
      <div class="loading-status">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading order details...</p>
      </div>
    </div>

    <div class="notification-section">
      <h3><i class="fas fa-bell"></i> Order Updates</h3>
      
      <div class="notification-toggle">
        <label>
          <input type="checkbox" id="enableNotifications" checked>
          Receive status updates
        </label>
      </div>
      
      <div class="notification-history">
        <h4>Recent Updates</h4>
        <div id="notificationList" class="notification-items">
          <!-- Notifications will load here -->
        </div>
      </div>
    </div>

    <div class="order-actions">
      <a href="menu.html" class="mobile-cta-btn">Order Again</a>
      <a href="index.html" class="mobile-cta-btn secondary">Back to Home</a>
    </div>
  </div>

  <script type="module">
    // Import from shared.js (local file)
    import { 
      db, 
      formatPrice, 
      getNotificationPreferences, 
      updateNotificationPreferences 
    } from './js/shared.js';

    // Import Firestore helpers from CDN
    import { 
      doc, getDoc, onSnapshot, 
      collection, query, where, orderBy, limit, getDocs 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('orderId');
      
      if (!orderId) {
        window.location.href = 'index.html';
        return;
      }
      
      loadOrderStatus(orderId);
      
      // Load notification preferences
      const phoneNumber = await getOrderPhoneNumber(orderId);
      if (phoneNumber) {
        const prefs = await getNotificationPreferences(phoneNumber);
        
        document.getElementById('enableNotifications').checked = prefs.statusUpdates;
        
        document.getElementById('enableNotifications').addEventListener('change', async (e) => {
          await updateNotificationPreferences(phoneNumber, {
            ...prefs,
            statusUpdates: e.target.checked
          });
          
          if (e.target.checked) {
            showNotification('You will now receive updates about this order');
          }
        });
      }
      
      loadOrderNotifications(orderId);
    });
    
    async function getOrderPhoneNumber(orderId) {
      try {
        const orderRef = doc(db, 'orders', orderId);
        const orderDoc = await getDoc(orderRef);
        if (orderDoc.exists()) {
          return orderDoc.data().customerPhone;
        }
        return null;
      } catch (error) {
        console.error('Error getting order phone number:', error);
        return null;
      }
    }
    
    function loadOrderStatus(orderId) {
      const orderRef = doc(db, 'orders', orderId);
      
      onSnapshot(orderRef, (docSnap) => {
        if (!docSnap.exists()) {
          showError('Order not found');
          return;
        }
        
        const order = docSnap.data();
        order.id = docSnap.id;
        renderOrderStatus(order);
      }, (error) => {
        console.error('Error loading order:', error);
        showError('Failed to load order details');
      });
    }
    
    async function loadOrderNotifications(orderId) {
      try {
        const notificationsRef = query(
          collection(db, 'notifications'),
          where('orderId', '==', orderId),
          orderBy('timestamp', 'desc'),
          limit(5)
        );
        
        const snapshot = await getDocs(notificationsRef);
        const container = document.getElementById('notificationList');
        
        if (snapshot.empty) {
          container.innerHTML = '<p>No updates yet</p>';
          return;
        }
        
        container.innerHTML = '';
        snapshot.forEach(docSnap => {
          const notif = docSnap.data();
          const item = document.createElement('div');
          item.className = 'notification-item';
          item.innerHTML = `
            <p><strong>${notif.title}</strong></p>
            <p>${notif.body}</p>
            <small>${notif.timestamp?.toDate().toLocaleString() || ''}</small>
          `;
          container.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notificationList').innerHTML = '<p>Error loading updates</p>';
      }
    }
    
    function renderOrderStatus(order) {
      const container = document.getElementById('orderStatusContainer');
      
      const statusInfo = {
        pending: { text: 'Order Received', icon: 'fa-hourglass-start', color: '#ff9800' },
        preparing: { text: 'Preparing Your Order', icon: 'fa-utensils', color: '#2196f3' },
        delivering: { text: 'Out for Delivery', icon: 'fa-truck', color: '#4caf50' },
        completed: { text: 'Delivered', icon: 'fa-check-circle', color: '#8bc34a' },
        cancelled: { text: 'Cancelled', icon: 'fa-times-circle', color: '#f44336' }
      };
      
      const status = statusInfo[order.status] || statusInfo.pending;
      
      let itemsHtml = '';
      if (order.items && order.items.length > 0) {
        itemsHtml = order.items.map(item => `
          <li class="order-item">
            <span class="item-quantity">${item.quantity}x</span>
            <span class="item-name">${item.name}${item.variant ? ` (${item.variant})` : ''}</span>
            <span class="item-price">${formatPrice(item.price * item.quantity)}</span>
          </li>
        `).join('');
      }
      
      container.innerHTML = `
        <div class="order-header">
          <h2>Order #${order.id}</h2>
          <div class="order-status-badge" style="background-color: ${status.color}">
            <i class="fas ${status.icon}"></i> ${status.text}
          </div>
        </div>
        
        <div class="order-details">
          <div class="detail-section">
            <h3><i class="fas fa-info-circle"></i> Order Details</h3>
            <p><strong>Order Type:</strong> ${order.orderType}</p>
            <p><strong>Order Time:</strong> ${order.timestamp?.toDate().toLocaleString() || 'N/A'}</p>
            ${order.orderType === 'Delivery' ? `
              <p><strong>Delivery Address:</strong> ${order.deliveryAddress || 'Not specified'}</p>
            ` : ''}
          </div>
          
          <div class="detail-section">
            <h3><i class="fas fa-list"></i> Items</h3>
            <ul class="order-items">
              ${itemsHtml || '<li>No items found</li>'}
            </ul>
          </div>
          
          <div class="detail-section">
            <h3><i class="fas fa-receipt"></i> Payment Summary</h3>
            <div class="payment-summary">
              <p><strong>Subtotal:</strong> ${formatPrice(order.subtotal || 0)}</p>
              ${order.orderType === 'Delivery' ? `
                <p><strong>Delivery Charge:</strong> ${formatPrice(order.deliveryCharge || 0)}</p>
              ` : ''}
              <p class="total"><strong>Total:</strong> ${formatPrice(order.total || 0)}</p>
            </div>
          </div>
        </div>
      `;
    }
    
    function showError(message) {
      const container = document.getElementById('orderStatusContainer');
      container.innerHTML = `
        <div class="error-message">
          <i class="fas fa-exclamation-triangle"></i>
          <p>${message}</p>
          <a href="index.html" class="mobile-cta-btn">Back to Home</a>
        </div>
      `;
    }
  </script>
</body>
</html>
