<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bake & Grill - Phone OTP + Full Site</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #recaptcha-container { display: none; }
  </style>
</head>
<body>

  <!-- ‚úÖ Phone OTP Login -->
  <div id="authSection">
    <h2>Login with Phone</h2>
    <input id="phoneNumber" placeholder="+91XXXXXXXXXX" /><br/><br/>
    <div id="recaptcha-container"></div><br/>
    <button onclick="sendOTP()">Send OTP</button><br/><br/>
    <input id="otpCode" placeholder="Enter OTP" /><br/>
    <button onclick="verifyOTP()">Verify OTP</button>
  </div>

  <!-- ‚úÖ Full Site Content -->
  <div id="mainSite" style="display:none;">

    <!-- ‚úÖ Example: YOUR FULL SITE GOES HERE -->
    <h1>üçï Bake & Grill - Full Ordering Site</h1>
    <p>‚úÖ This is your full ordering site content.</p>

    <!-- Example: Order Form -->
    <input id="customerName" placeholder="Your Name" /><br/>
    <label><input type="radio" name="orderType" value="Delivery" checked /> Delivery</label>
    <label><input type="radio" name="orderType" value="Pickup" /> Pickup</label><br/><br/>
    <button onclick="confirmOrder()">Confirm Order</button>

    <!-- ‚úÖ Add all your real site content here:
         ‚úÖ Your full menu, sections, tabs, cart, location, etc.
         ‚úÖ Leave the Phone OTP section OUTSIDE ‚Äî keep it above!
    -->

  </div>

  <!-- ‚úÖ Firebase + OTP + Order Save -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // ‚úÖ Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCLTNqd_JiizF91O8qeDMzy5HXAEDEogWY",
      authDomain: "bakeandgrillorder.firebaseapp.com",
      projectId: "bakeandgrillorder",
      storageBucket: "bakeandgrillorder.firebasestorage.app",
      messagingSenderId: "51671422767",
      appId: "1:51671422767:web:7898ed22e2b18cae0933da",
      measurementId: "G-QYM9FKZ0SL"
    };

    // ‚úÖ Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ‚úÖ reCAPTCHA - invisible
    window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {
      'size': 'invisible'
    }, auth);

    let confirmationResult = null;

    // ‚úÖ Send OTP
    window.sendOTP = function() {
      const phone = document.getElementById("phoneNumber").value.trim();
      signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
        .then((result) => {
          confirmationResult = result;
          alert("‚úÖ OTP sent to " + phone);
        })
        .catch((error) => {
          console.error(error);
          alert("‚ùå Failed to send OTP: " + error.message);
        });
    };

    // ‚úÖ Verify OTP
    window.verifyOTP = function() {
      const code = document.getElementById("otpCode").value.trim();
      confirmationResult.confirm(code)
        .then(async (result) => {
          const user = result.user;
          console.log("‚úÖ Phone verified:", user.phoneNumber);

          // ‚úÖ Create user doc if new
          const userRef = doc(db, "users", user.uid);
          const snap = await getDoc(userRef);
          if (!snap.exists()) {
            await setDoc(userRef, {
              phone: user.phoneNumber,
              joined: serverTimestamp()
            });
          }

          // ‚úÖ Hide auth, show full site
          document.getElementById("authSection").style.display = "none";
          document.getElementById("mainSite").style.display = "block";
        })
        .catch((error) => {
          console.error(error);
          alert("‚ùå Invalid OTP: " + error.message);
        });
    };

    // ‚úÖ Confirm Order
    window.confirmOrder = async function() {
      const user = auth.currentUser;
      if (!user) {
        alert("You must log in first.");
        return;
      }

      const name = document.getElementById("customerName").value.trim();
      const orderType = document.querySelector('input[name="orderType"]:checked').value;

      if (!name) {
        alert("Please enter your name.");
        return;
      }

      // ‚úÖ Example logic - replace with your actual cart total
      const subtotal = 500;
      const deliveryCharge = orderType === "Delivery" ? 30 : 0;
      const total = subtotal + deliveryCharge;

      await addDoc(collection(db, "orders"), {
        uid: user.uid,
        name: name,
        phone: user.phoneNumber,
        orderType: orderType,
        subtotal: subtotal,
        deliveryCharge: deliveryCharge,
        total: total,
        timestamp: serverTimestamp()
      });

      alert("‚úÖ Order placed! Thank you.");
    };
  </script>

</body>
</html>
