<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bake & Grill - Admin Panel</title>
  <style>
    :root {
      --primary-color: #d62828;
      --secondary-color: #f77f00;
      --light-bg: #fff8f0;
      --light-accent: #ffe5d9;
      --dark-text: #222;
      --medium-text: #555;
      --light-text: #777;
      --success-color: #2e7d32;
      --error-color: #c62828;
      --warning-color: #ff8f00;
      --admin-dark: #1a1a2e;
      --admin-light: #16213e;
      --admin-accent: #0f3460;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: var(--dark-text);
      line-height: 1.6;
    }
    
    .admin-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar Styles */
    .sidebar {
      width: 250px;
      background: var(--admin-dark);
      color: white;
      padding: 1rem 0;
      transition: all 0.3s ease;
    }
    
    .sidebar-header {
      padding: 0 1rem 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    
    .sidebar-header h2 {
      color: white;
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }
    
    .sidebar-header p {
      color: rgba(255,255,255,0.7);
      font-size: 0.8rem;
    }
    
    .sidebar-menu {
      padding: 1rem 0;
    }
    
    .menu-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
    }
    
    .menu-item:hover {
      background: var(--admin-accent);
    }
    
    .menu-item.active {
      background: var(--admin-accent);
      border-left: 4px solid var(--primary-color);
    }
    
    .menu-item i {
      margin-right: 0.75rem;
      font-size: 1.1rem;
    }
    
    /* Main Content Styles */
    .main-content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    
    .admin-header h1 {
      color: var(--primary-color);
      font-size: 1.5rem;
    }
    
    .admin-header .user-info {
      display: flex;
      align-items: center;
    }
    
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 0.75rem;
    }
    
    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .card-title {
      font-size: 1rem;
      color: var(--medium-text);
    }
    
    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    
    .card-value {
      font-size: 1.75rem;
      font-weight: bold;
      color: var(--dark-text);
      margin-bottom: 0.5rem;
    }
    
    .card-footer {
      font-size: 0.875rem;
      color: var(--light-text);
    }
    
    /* Table Styles */
    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background: #f9f9f9;
      font-weight: 600;
      color: var(--medium-text);
    }
    
    tr:hover {
      background: #f5f5f5;
    }
    
    .status {
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .status-pending {
      background: #fff3e0;
      color: #e65100;
    }
    
    .status-preparing {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .status-ready {
      background: #fff8e1;
      color: #ff8f00;
    }
    
    .status-delivered {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status-cancelled {
      background: #ffebee;
      color: #c62828;
    }
    
    .status-active {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status-inactive {
      background: #ffebee;
      color: #c62828;
    }
    
    .status-available {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .action-btn {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s ease;
      margin-right: 0.25rem;
    }
    
    .action-btn.view {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .action-btn.edit {
      background: #fff8e1;
      color: #ff8f00;
    }
    
    .action-btn.delete {
      background: #ffebee;
      color: #c62828;
    }
    
    .action-btn:hover {
      opacity: 0.8;
    }
    
    /* Form Styles */
    .form-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .form-title {
      font-size: 1.25rem;
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 1rem;
    }
    
    .form-group textarea {
      min-height: 100px;
    }
    
    .form-row {
      display: flex;
      gap: 1rem;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background: #a4161a;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    /* Variant Management */
    .variant-container {
      margin-top: 1rem;
      border: 1px dashed #ddd;
      padding: 1rem;
      border-radius: 4px;
    }
    
    .variant-item {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .variant-item input {
      flex: 1;
    }
    
    .variant-item .btn {
      padding: 0.5rem;
    }
    
    .add-variant-btn {
      margin-top: 0.5rem;
      background: #e8f5e9;
      color: var(--success-color);
      border: 1px dashed var(--success-color);
    }
    
    .add-variant-btn:hover {
      background: #c8e6c9;
    }
    
    /* Order Item Styles */
    .order-item {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px dashed #eee;
    }
    
    .order-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .order-item-select {
      width: 100%;
    }
    
    .order-item-variant {
      min-width: 120px;
    }
    
    .order-item-qty {
      width: 100%;
    }
    
    .order-item-price {
      width: 100%;
      background-color: #f5f5f5;
    }
    
    /* Tabs */
    .admin-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 1.5rem;
    }
    
    .admin-tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
    }
    
    .admin-tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: modalopen 0.3s;
    }
    
    @keyframes modalopen {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      color: var(--primary-color);
    }
    
    .close-modal {
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
    }
    
    .close-modal:hover {
      color: var(--primary-color);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }
    
    /* Order Details */
    .order-details {
      margin-bottom: 1.5rem;
    }
    
    .order-detail-item {
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px dashed #eee;
    }
    
    .order-detail-item strong {
      display: inline-block;
      min-width: 120px;
    }
    
    /* Image Preview */
    .image-preview {
      max-width: 200px;
      max-height: 200px;
      margin-top: 0.5rem;
      display: none;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1001;
      animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
    }
    
    .notification.success {
      background-color: var(--success-color);
    }
    
    .notification.error {
      background-color: var(--error-color);
    }
    
    .notification.warning {
      background-color: var(--warning-color);
    }
    
    .notification.info {
      background-color: #1565c0;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
        overflow: hidden;
      }
      
      .sidebar-header h2,
      .sidebar-header p,
      .menu-item span {
        display: none;
      }
      
      .menu-item {
        justify-content: center;
        padding: 0.75rem;
      }
      
      .menu-item i {
        margin-right: 0;
        font-size: 1.25rem;
      }
    }
    
    @media (max-width: 768px) {
      .admin-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        padding: 0.5rem;
      }
      
      .sidebar-menu {
        display: flex;
        overflow-x: auto;
        padding: 0.5rem 0;
      }
      
      .menu-item {
        padding: 0.5rem 1rem;
        white-space: nowrap;
      }
      
      .menu-item span {
        display: inline;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr 1fr;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }
    
    @media (max-width: 576px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .admin-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .admin-header .user-info {
        margin-top: 1rem;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Bake & Grill</h2>
        <p>Admin Panel</p>
      </div>
      
      <div class="sidebar-menu">
        <div class="menu-item active" data-section="dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
        </div>
        <div class="menu-item" data-section="orders">
          <i class="fas fa-clipboard-list"></i>
          <span>Orders</span>
        </div>
        <div class="menu-item" data-section="menu">
          <i class="fas fa-utensils"></i>
          <span>Menu Management</span>
        </div>
        <div class="menu-item" data-section="customers">
          <i class="fas fa-users"></i>
          <span>Customers</span>
        </div>
        <div class="menu-item" data-section="delivery">
          <i class="fas fa-motorcycle"></i>
          <span>Delivery</span>
        </div>
        <div class="menu-item" data-section="settings">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </div>
        <div class="menu-item" data-section="reports">
          <i class="fas fa-chart-bar"></i>
          <span>Reports</span>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="admin-header">
        <h1 id="admin-section-title">Dashboard</h1>
        <div class="user-info">
          <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="Admin">
          <span>Admin</span>
          <button class="btn btn-secondary" style="margin-left: 1rem;" onclick="logout()">Logout</button>
        </div>
      </div>
      
      <!-- Dashboard Section -->
      <div id="dashboard" class="admin-section active">
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Today's Orders</div>
              <div class="card-icon" style="background: #e3f2fd; color: #1565c0;">
                <i class="fas fa-shopping-bag"></i>
              </div>
            </div>
            <div class="card-value" id="today-orders">0</div>
            <div class="card-footer" id="orders-change">Loading...</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">Revenue</div>
              <div class="card-icon" style="background: #e8f5e9; color: #2e7d32;">
                <i class="fas fa-rupee-sign"></i>
              </div>
            </div>
            <div class="card-value" id="today-revenue">â‚¹0</div>
            <div class="card-footer" id="revenue-change">Loading...</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">Pending Orders</div>
              <div class="card-icon" style="background: #fff3e0; color: #e65100;">
                <i class="fas fa-clock"></i>
              </div>
            </div>
            <div class="card-value" id="pending-orders-count">0</div>
            <div class="card-footer">Need attention</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">Active Customers</div>
              <div class="card-icon" style="background: #f3e5f5; color: #7b1fa2;">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="card-value" id="active-customers">0</div>
            <div class="card-footer">This month</div>
          </div>
        </div>
        
        <div class="table-container">
          <h2>Recent Orders</h2>
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="recent-orders">
              <tr>
                <td colspan="6" style="text-align: center;">Loading orders...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Orders Section -->
      <div id="orders" class="admin-section">
        <div class="table-container">
          <div class="admin-tabs">
            <div class="admin-tab active" onclick="showOrderTab('all')">All Orders</div>
            <div class="admin-tab" onclick="showOrderTab('pending')">Pending</div>
            <div class="admin-tab" onclick="showOrderTab('preparing')">Preparing</div>
            <div class="admin-tab" onclick="showOrderTab('ready')">Ready</div>
            <div class="admin-tab" onclick="showOrderTab('delivered')">Delivered</div>
            <div class="admin-tab" onclick="showOrderTab('cancelled')">Cancelled</div>
          </div>
          
          <div class="tab-content active" id="all-orders">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="all-orders-body">
                <tr>
                  <td colspan="7" style="text-align: center;">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="tab-content" id="pending-orders">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pending-orders-body">
                <tr>
                  <td colspan="6" style="text-align: center;">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="tab-content" id="preparing-orders">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="preparing-orders-body">
                <tr>
                  <td colspan="6" style="text-align: center;">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="tab-content" id="ready-orders">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ready-orders-body">
                <tr>
                  <td colspan="6" style="text-align: center;">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="tab-content" id="delivered-orders">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="delivered-orders-body">
                <tr>
                  <td colspan="6" style="text-align: center;">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="tab-content" id="cancelled-orders">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="cancelled-orders-body">
                <tr>
                  <td colspan="6" style="text-align: center;">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Menu Management Section -->
      <div id="menu" class="admin-section">
        <div class="admin-tabs">
          <div class="admin-tab active" onclick="showMenuTab('categories')">Categories</div>
          <div class="admin-tab" onclick="showMenuTab('items')">Menu Items</div>
          <div class="admin-tab" onclick="showMenuTab('add')">Add New Item</div>
        </div>
        
        <div class="tab-content active" id="categories-tab">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Items</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="categories-body">
                <tr>
                  <td colspan="4" style="text-align: center;">Loading categories...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="form-container">
            <h3 class="form-title">Add New Category</h3>
            <form id="addCategoryForm">
              <div class="form-group">
                <label for="categoryName">Category Name</label>
                <input type="text" id="categoryName" required>
              </div>
              <div class="form-group">
                <label for="categoryIcon">Icon (Emoji or Font Awesome class)</label>
                <input type="text" id="categoryIcon" placeholder="ðŸ• or fas fa-pizza-slice" required>
              </div>
              <div class="form-group">
                <label for="categoryStatus">Status</label>
                <select id="categoryStatus" required>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">
                <span id="add-category-btn-text">Add Category</span>
                <span id="add-category-spinner" class="spinner" style="display: none;"></span>
              </button>
            </form>
          </div>
        </div>
        
        <div class="tab-content" id="items-tab">
          <div class="table-container">
            <div class="form-group" style="margin-bottom: 1rem;">
              <select id="filterCategory" style="width: 200px;" onchange="filterMenuItems()">
                <option value="">All Categories</option>
              </select>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Category</th>
                  <th>Price Range</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="menu-items-body">
                <tr>
                  <td colspan="5" style="text-align: center;">Loading menu items...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="tab-content" id="add-item-tab">
          <div class="form-container">
            <h3 class="form-title">Add New Menu Item</h3>
            <form id="addMenuItemForm">
              <div class="form-row">
                <div class="form-group">
                  <label for="itemName">Item Name</label>
                  <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                  <label for="itemNameBn">Bengali Name (Optional)</label>
                  <input type="text" id="itemNameBn">
                </div>
              </div>
              
              <div class="form-group">
                <label for="itemCategory">Category</label>
                <select id="itemCategory" required>
                  <option value="">Select Category</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="itemImage">Item Image</label>
                <input type="file" id="itemImage" accept="image/*">
                <img id="itemImagePreview" class="image-preview" src="#" alt="Image Preview">
              </div>
              
              <div class="form-group">
                <label for="itemDescription">Description</label>
                <textarea id="itemDescription"></textarea>
              </div>
              
              <div class="form-group">
                <label>Variants & Prices</label>
                <div class="variant-container" id="variantContainer">
                  <div class="variant-item">
                    <input type="text" placeholder="Variant name (e.g., Small, Medium)" required>
                    <input type="number" placeholder="Price" min="0" required>
                    <button type="button" class="btn btn-secondary" onclick="removeVariant(this)">Remove</button>
                  </div>
                </div>
                <button type="button" class="btn add-variant-btn" onclick="addVariant()">
                  <i class="fas fa-plus"></i> Add Variant
                </button>
              </div>
              
              <div class="form-group">
                <label for="itemStatus">Status</label>
                <select id="itemStatus" required>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="deliveryAvailable">Available for Delivery?</label>
                <select id="deliveryAvailable">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
              
              <button type="submit" class="btn btn-primary">
                <span id="add-item-btn-text">Add Menu Item</span>
                <span id="add-item-spinner" class="spinner" style="display: none;"></span>
              </button>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Customers Section -->
      <div id="customers" class="admin-section">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th>Phone</th>
                <th>Orders</th>
                <th>Total Spent</th>
                <th>Last Order</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customers-body">
              <tr>
                <td colspan="6" style="text-align: center;">Loading customers...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Delivery Section -->
      <div id="delivery" class="admin-section">
        <div class="form-container">
          <h3 class="form-title">Delivery Settings</h3>
          <form id="deliverySettingsForm">
            <div class="form-group">
              <label for="minDeliveryOrder">Minimum Order for Delivery (â‚¹)</label>
              <input type="number" id="minDeliveryOrder" value="200" min="0" required>
            </div>
            
            <div class="form-group">
              <label for="deliveryRadius">Maximum Delivery Radius (km)</label>
              <input type="number" id="deliveryRadius" value="8" min="1" required>
            </div>
            
            <div class="form-group">
              <label for="freeDeliveryThreshold">Free Delivery Threshold (â‚¹)</label>
              <input type="number" id="freeDeliveryThreshold" value="500" min="0" required>
            </div>
            
            <div class="form-group">
              <label>Delivery Charges</label>
              <div class="form-row">
                <div class="form-group">
                  <label for="deliveryCharge1">0-4 km (â‚¹)</label>
                  <input type="number" id="deliveryCharge1" value="0" min="0" required>
                </div>
                <div class="form-group">
                  <label for="deliveryCharge2">4-6 km (â‚¹)</label>
                  <input type="number" id="deliveryCharge2" value="20" min="0" required>
                </div>
                <div class="form-group">
                  <label for="deliveryCharge3">6-8 km (â‚¹)</label>
                  <input type="number" id="deliveryCharge3" value="30" min="0" required>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="prepTime">Preparation Time (minutes)</label>
              <input type="number" id="prepTime" value="20" min="0" required>
            </div>
            
            <div class="form-group">
              <label for="travelTimePerKm">Travel Time per km (minutes)</label>
              <input type="number" id="travelTimePerKm" value="8" min="1" required>
            </div>
            
            <button type="submit" class="btn btn-primary">
              <span id="delivery-settings-btn-text">Save Settings</span>
              <span id="delivery-settings-spinner" class="spinner" style="display: none;"></span>
            </button>
          </form>
        </div>
        
        <div class="table-container">
          <h2>Delivery Staff</h2>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Vehicle</th>
                <th>Status</th>
                <th>Current Order</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="delivery-staff-body">
              <tr>
                <td colspan="6" style="text-align: center;">Loading delivery staff...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Settings Section -->
      <div id="settings" class="admin-section">
        <div class="form-container">
          <h3 class="form-title">Restaurant Information</h3>
          <form id="restaurantInfoForm">
            <div class="form-group">
              <label for="restaurantName">Restaurant Name</label>
              <input type="text" id="restaurantName" value="Bake & Grill" required>
            </div>
            
            <div class="form-group">
              <label for="restaurantTagline">Tagline</label>
              <input type="text" id="restaurantTagline" value="Delicious food delivered to your doorstep" required>
            </div>
            
            <div class="form-group">
              <label for="restaurantAddress">Address</label>
              <textarea id="restaurantAddress" required>123 Food Street, Kolkata, West Bengal - 700001</textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="restaurantPhone">Phone Number</label>
                <input type="tel" id="restaurantPhone" value="+918240266267" required>
              </div>
              <div class="form-group">
                <label for="restaurantEmail">Email</label>
                <input type="email" id="restaurantEmail" value="contact@bakeandgrill.com" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="restaurantLat">Latitude</label>
                <input type="text" id="restaurantLat" value="22.3908" required>
              </div>
              <div class="form-group">
                <label for="restaurantLng">Longitude</label>
                <input type="text" id="restaurantLng" value="88.2189" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="restaurantHours">Opening Hours</label>
              <input type="text" id="restaurantHours" value="10:00 AM - 10:00 PM (Daily)" required>
            </div>
            
            <button type="submit" class="btn btn-primary">
              <span id="restaurant-info-btn-text">Save Information</span>
              <span id="restaurant-info-spinner" class="spinner" style="display: none;"></span>
            </button>
          </form>
        </div>
        
        <div class="form-container">
          <h3 class="form-title">Admin Settings</h3>
          <form id="adminSettingsForm">
            <div class="form-group">
              <label for="adminName">Admin Name</label>
              <input type="text" id="adminName" value="Admin" required>
            </div>
            
            <div class="form-group">
              <label for="adminEmail">Admin Email</label>
              <input type="email" id="adminEmail" value="admin@bakeandgrill.com" required>
            </div>
            
            <div class="form-group">
              <label for="adminPhone">Admin Phone</label>
              <input type="tel" id="adminPhone" value="+919876543210" required>
            </div>
            
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            
            <button type="submit" class="btn btn-primary">
              <span id="admin-settings-btn-text">Save Settings</span>
              <span id="admin-settings-spinner" class="spinner" style="display: none;"></span>
            </button>
          </form>
        </div>
      </div>
      
      <!-- Reports Section -->
      <div id="reports" class="admin-section">
        <div class="form-container">
          <h3 class="form-title">Generate Reports</h3>
          <form id="reportForm">
            <div class="form-row">
              <div class="form-group">
                <label for="reportType">Report Type</label>
                <select id="reportType" required>
                  <option value="">Select Report Type</option>
                  <option value="sales">Sales Report</option>
                  <option value="orders">Orders Report</option>
                  <option value="customers">Customers Report</option>
                  <option value="items">Popular Items</option>
                  <option value="delivery">Delivery Performance</option>
                </select>
              </div>
              <div class="form-group">
                <label for="timePeriod">Time Period</label>
                <select id="timePeriod" required>
                  <option value="today">Today</option>
                  <option value="yesterday">Yesterday</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="quarter">This Quarter</option>
                  <option value="year">This Year</option>
                  <option value="custom">Custom Range</option>
                </select>
              </div>
            </div>
            
            <div class="form-row" id="customDateRange" style="display: none;">
              <div class="form-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate">
              </div>
              <div class="form-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate">
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary">
              <span id="generate-report-btn-text">Generate Report</span>
              <span id="generate-report-spinner" class="spinner" style="display: none;"></span>
            </button>
            <button type="button" class="btn btn-secondary">Export to Excel</button>
            <button type="button" class="btn btn-secondary">Print Report</button>
          </form>
        </div>
        
        <div class="table-container">
          <h2>Sales Summary (Last 7 Days)</h2>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Orders</th>
                <th>Revenue</th>
                <th>Delivery</th>
                <th>Pickup</th>
                <th>Dine In</th>
              </tr>
            </thead>
            <tbody id="sales-summary-body">
              <tr>
                <td colspan="6" style="text-align: center;">No report generated yet</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="table-container">
          <h2>Top Selling Items (Last 7 Days)</h2>
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Category</th>
                <th>Orders</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody id="top-items-body">
              <tr>
                <td colspan="4" style="text-align: center;">No report generated yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Order Details Modal -->
  <div id="orderDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Order Details - <span id="modalOrderId"></span></h3>
        <span class="close-modal" onclick="closeModal('orderDetailsModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="order-details">
          <div class="order-detail-item">
            <strong>Customer:</strong> <span id="modalCustomerName"></span>
          </div>
          <div class="order-detail-item">
            <strong>Phone:</strong> <span id="modalCustomerPhone"></span>
          </div>
          <div class="order-detail-item">
            <strong>Order Type:</strong> <span id="modalOrderType"></span>
          </div>
          <div class="order-detail-item" id="modalDeliveryAddressContainer">
            <strong>Delivery Address:</strong> <span id="modalDeliveryAddress"></span>
          </div>
          <div class="order-detail-item">
            <strong>Order Date:</strong> <span id="modalOrderDate"></span>
          </div>
          <div class="order-detail-item">
            <strong>Status:</strong> <span id="modalOrderStatus"></span>
          </div>
          
          <h4 style="margin-top: 1.5rem;">Order Items</h4>
          <table style="width: 100%; margin-top: 0.5rem;">
            <thead>
              <tr>
                <th>Item</th>
                <th>Variant</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody id="modalOrderItems">
              <!-- Order items will be inserted here -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="2" style="text-align: right; font-weight: bold;">Subtotal:</td>
                <td id="modalOrderSubtotal"></td>
              </tr>
              <tr id="modalDeliveryChargeRow">
                <td colspan="2" style="text-align: right; font-weight: bold;">Delivery Charge:</td>
                <td id="modalOrderDeliveryCharge"></td>
              </tr>
              <tr>
                <td colspan="2" style="text-align: right; font-weight: bold;">Total:</td>
                <td id="modalOrderTotal"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <div class="form-group" style="margin-top: 1.5rem;">
          <label for="updateOrderStatus">Update Status</label>
          <select id="updateOrderStatus" class="form-control">
            <option value="pending">Pending</option>
            <option value="preparing">Preparing</option>
            <option value="ready">Ready for Pickup/Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        
        <div class="form-group" id="deliveryPersonContainer" style="display: none;">
          <label for="deliveryPerson">Assign Delivery Person</label>
          <select id="deliveryPerson" class="form-control">
            <option value="">Select Delivery Person</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('orderDetailsModal')">Close</button>
        <button class="btn btn-primary" onclick="updateOrderStatus()" id="update-status-btn">
          <span>Update Status</span>
          <span class="spinner" id="update-status-spinner" style="display: none;"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="editOrderModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Edit Order - <span id="editOrderId"></span></h3>
        <span class="close-modal" onclick="closeModal('editOrderModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="editOrderForm">
          <input type="hidden" id="editOrderDocId">
          <div class="form-row">
            <div class="form-group">
              <label for="editOrderCustomerName">Customer Name</label>
              <input type="text" id="editOrderCustomerName" required>
            </div>
            <div class="form-group">
              <label for="editOrderCustomerPhone">Phone</label>
              <input type="tel" id="editOrderCustomerPhone" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="editOrderType">Order Type</label>
            <select id="editOrderType" required>
              <option value="Delivery">Delivery</option>
              <option value="Pickup">Pickup</option>
              <option value="Dine In">Dine In</option>
            </select>
          </div>
          
          <div class="form-group" id="editOrderAddressGroup">
            <label for="editOrderAddress">Delivery Address</label>
            <textarea id="editOrderAddress"></textarea>
          </div>
          
          <div class="form-group">
            <label>Order Items</label>
            <div id="editOrderItemsContainer">
              <!-- Order items will be loaded here -->
            </div>
            <button type="button" class="btn btn-secondary" onclick="addOrderItem()">
              <i class="fas fa-plus"></i> Add Item
            </button>
          </div>
          
          <div class="form-group">
            <label for="editOrderStatus">Status</label>
            <select id="editOrderStatus" required>
              <option value="pending">Pending</option>
              <option value="preparing">Preparing</option>
              <option value="ready">Ready</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="editOrderSubtotal">Subtotal (â‚¹)</label>
              <input type="number" id="editOrderSubtotal" min="0" step="0.01" readonly>
            </div>
            <div class="form-group">
              <label for="editOrderDeliveryCharge">Delivery Charge (â‚¹)</label>
              <input type="number" id="editOrderDeliveryCharge" min="0" step="0.01">
            </div>
            <div class="form-group">
              <label for="editOrderTotal">Total (â‚¹)</label>
              <input type="number" id="editOrderTotal" min="0" step="0.01" readonly>
            </div>
          </div>
          
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeModal('editOrderModal')">Cancel</button>
            <button class="btn btn-primary" type="submit">
              <span id="update-order-btn-text">Update Order</span>
              <span id="update-order-spinner" class="spinner" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Menu Item Modal -->
  <div id="editMenuItemModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Edit Menu Item</h3>
        <span class="close-modal" onclick="closeModal('editMenuItemModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="editMenuItemForm">
          <input type="hidden" id="editItemId">
          <div class="form-row">
            <div class="form-group">
              <label for="editItemName">Item Name</label>
              <input type="text" id="editItemName" required>
            </div>
            <div class="form-group">
              <label for="editItemNameBn">Bengali Name (Optional)</label>
              <input type="text" id="editItemNameBn">
            </div>
          </div>
          
          <div class="form-group">
            <label for="editItemCategory">Category</label>
            <select id="editItemCategory" required>
              <option value="">Select Category</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="editItemImage">Item Image</label>
            <input type="file" id="editItemImage" accept="image/*">
            <img id="editCurrentImage" class="image-preview" src="#" alt="Current Image">
          </div>
          
          <div class="form-group">
            <label for="editItemDescription">Description</label>
            <textarea id="editItemDescription"></textarea>
          </div>
          
          <div class="form-group">
            <label>Variants & Prices</label>
            <div class="variant-container" id="editVariantContainer">
              <!-- Variants will be loaded here -->
            </div>
            <button type="button" class="btn add-variant-btn" onclick="addEditVariant()">
              <i class="fas fa-plus"></i> Add Variant
            </button>
          </div>
          
          <div class="form-group">
            <label for="editItemStatus">Status</label>
            <select id="editItemStatus" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="editDeliveryAvailable">Available for Delivery?</label>
            <select id="editDeliveryAvailable">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeModal('editMenuItemModal')">Cancel</button>
            <button class="btn btn-primary" type="submit">
              <span id="update-item-btn-text">Update Item</span>
              <span id="update-item-spinner" class="spinner" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div id="editCategoryModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Edit Category</h3>
        <span class="close-modal" onclick="closeModal('editCategoryModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="editCategoryForm">
          <input type="hidden" id="editCategoryId">
          <div class="form-group">
            <label for="editCategoryName">Category Name</label>
            <input type="text" id="editCategoryName" required>
          </div>
          <div class="form-group">
            <label for="editCategoryIcon">Icon (Emoji or Font Awesome class)</label>
            <input type="text" id="editCategoryIcon" placeholder="ðŸ• or fas fa-pizza-slice" required>
          </div>
          <div class="form-group">
            <label for="editCategoryStatus">Status</label>
            <select id="editCategoryStatus" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeModal('editCategoryModal')">Cancel</button>
            <button class="btn btn-primary" type="submit">
              <span id="update-category-btn-text">Update Category</span>
              <span id="update-category-spinner" class="spinner" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div id="editCustomerModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Edit Customer</h3>
        <span class="close-modal" onclick="closeModal('editCustomerModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="editCustomerForm">
          <input type="hidden" id="editCustomerId">
          <div class="form-row">
            <div class="form-group">
              <label for="editCustomerName">Name</label>
              <input type="text" id="editCustomerName" required>
            </div>
            <div class="form-group">
              <label for="editCustomerPhone">Phone</label>
              <input type="tel" id="editCustomerPhone" required>
            </div>
          </div>
          <div class="form-group">
            <label for="editCustomerEmail">Email</label>
            <input type="email" id="editCustomerEmail">
          </div>
          <div class="form-group">
            <label for="editCustomerAddress">Address</label>
            <textarea id="editCustomerAddress"></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeModal('editCustomerModal')">Cancel</button>
            <button class="btn btn-primary" type="submit">
              <span id="update-customer-btn-text">Update Customer</span>
              <span id="update-customer-spinner" class="spinner" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Delivery Staff Modal -->
  <div id="editDeliveryStaffModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Edit Delivery Staff</h3>
        <span class="close-modal" onclick="closeModal('editDeliveryStaffModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="editDeliveryStaffForm">
          <input type="hidden" id="editStaffId">
          <div class="form-row">
            <div class="form-group">
              <label for="editStaffName">Name</label>
              <input type="text" id="editStaffName" required>
            </div>
            <div class="form-group">
              <label for="editStaffPhone">Phone</label>
              <input type="tel" id="editStaffPhone" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editStaffVehicleType">Vehicle Type</label>
              <input type="text" id="editStaffVehicleType" required>
            </div>
            <div class="form-group">
              <label for="editStaffVehicleNumber">Vehicle Number</label>
              <input type="text" id="editStaffVehicleNumber" required>
            </div>
          </div>
          <div class="form-group">
            <label for="editStaffStatus">Status</label>
            <select id="editStaffStatus" required>
              <option value="available">Available</option>
              <option value="unavailable">Unavailable</option>
            </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" onclick="closeModal('editDeliveryStaffModal')">Cancel</button>
            <button class="btn btn-primary" type="submit">
              <span id="update-staff-btn-text">Update Staff</span>
              <span id="update-staff-spinner" class="spinner" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBuBmCQvvNVFsH2x6XGrHXrgZyULB1_qH8",
      authDomain: "bakeandgrill-44c25.firebaseapp.com",
      projectId: "bakeandgrill-44c25",
      storageBucket: "bakeandgrill-44c25.appspot.com",
      messagingSenderId: "713279633359",
      appId: "1:713279633359:web:ba6bcd411b1b6be7b904ba",
      measurementId: "G-SLG2R88J72"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ==================== AUTHENTICATION ====================
    // Check auth state
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        initializeAdminPanel();
      }
    });

    // Logout function
    function logout() {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        showNotification('error', 'Logout failed: ' + error.message);
      });
    }

    // ==================== UI FUNCTIONS ====================
    // Show/hide sections
    async function showSection(sectionId) {
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });
      
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      
      document.getElementById(sectionId).classList.add('active');
      document.querySelector(`.menu-item[data-section="${sectionId}"]`).classList.add('active');
      document.getElementById('admin-section-title').textContent = 
        document.querySelector(`.menu-item[data-section="${sectionId}"] span`).textContent;
      
      // Load data for the section
      await loadSectionData(sectionId);
    }
    
    // Order tabs
    function showOrderTab(tabId) {
      document.querySelectorAll('#orders .tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('#orders .admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(`${tabId}-orders`).classList.add('active');
      document.querySelector(`#orders .admin-tab[onclick="showOrderTab('${tabId}')"]`).classList.add('active');
      
      // Load data for the tab if needed
      if (document.getElementById(`${tabId}-orders-body`).innerHTML.includes('Loading')) {
        loadOrdersData(tabId);
      }
    }
    
    // Menu tabs
    function showMenuTab(tabId) {
      document.querySelectorAll('#menu .tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('#menu .admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(`${tabId}-tab`).classList.add('active');
      document.querySelector(`#menu .admin-tab[onclick="showMenuTab('${tabId}')"]`).classList.add('active');
      
      // Load data if needed
      if (tabId === 'items') {
        filterMenuItems();
      }
    }

    // Notification system
    function showNotification(type, message) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Variant management
    function addVariant() {
      const container = document.getElementById('variantContainer');
      const div = document.createElement('div');
      div.className = 'variant-item';
      div.innerHTML = `
        <input type="text" placeholder="Variant name (e.g., Small, Medium)" required>
        <input type="number" placeholder="Price" min="0" required>
        <button type="button" class="btn btn-secondary" onclick="removeVariant(this)">Remove</button>
      `;
      container.appendChild(div);
    }
    
    function addEditVariant(name = '', price = '') {
      const container = document.getElementById('editVariantContainer');
      const div = document.createElement('div');
      div.className = 'variant-item';
      div.innerHTML = `
        <input type="text" placeholder="Variant name (e.g., Small, Medium)" value="${name}" required>
        <input type="number" placeholder="Price" min="0" value="${price}" required>
        <button type="button" class="btn btn-secondary" onclick="removeVariant(this)">Remove</button>
      `;
      container.appendChild(div);
    }
    
    function removeVariant(button) {
      if (document.querySelectorAll('.variant-item').length > 1) {
        button.parentElement.remove();
      } else {
        showNotification('warning', 'At least one variant is required');
      }
    }

    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Image preview
    function setupImagePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      
      input.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
          }
          reader.readAsDataURL(file);
        }
      });
    }

    // ==================== INITIALIZATION ====================
    async function initializeAdminPanel() {
      // Set up menu item click handlers
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
          const sectionId = this.getAttribute('data-section');
          showSection(sectionId);
        });
      });
      
      // Set up image previews
      setupImagePreview('itemImage', 'itemImagePreview');
      setupImagePreview('editItemImage', 'editCurrentImage');
      
      // Load initial data for the active section
      const activeSection = document.querySelector('.admin-section.active').id;
      await loadSectionData(activeSection);
      
      // Set up event listeners
      document.getElementById('addCategoryForm')?.addEventListener('submit', handleAddCategory);
      document.getElementById('addMenuItemForm')?.addEventListener('submit', handleAddMenuItem);
      document.getElementById('deliverySettingsForm')?.addEventListener('submit', handleDeliverySettings);
      document.getElementById('restaurantInfoForm')?.addEventListener('submit', handleRestaurantInfo);
      document.getElementById('adminSettingsForm')?.addEventListener('submit', handleAdminSettings);
      document.getElementById('reportForm')?.addEventListener('submit', handleGenerateReport);
      
      // Edit form handlers
      document.getElementById('editMenuItemForm')?.addEventListener('submit', handleEditMenuItemSubmit);
      document.getElementById('editCategoryForm')?.addEventListener('submit', handleEditCategorySubmit);
      document.getElementById('editCustomerForm')?.addEventListener('submit', handleEditCustomerSubmit);
      document.getElementById('editDeliveryStaffForm')?.addEventListener('submit', handleEditDeliveryStaffSubmit);
      document.getElementById('editOrderForm')?.addEventListener('submit', handleEditOrderSubmit);
      
      // Custom date range toggle
      document.getElementById('timePeriod')?.addEventListener('change', function() {
        document.getElementById('customDateRange').style.display = 
          this.value === 'custom' ? 'flex' : 'none';
      });

      // Order type change handler
      document.getElementById('editOrderType')?.addEventListener('change', toggleOrderAddressField);
      
      // Delivery charge change handler
      document.getElementById('editOrderDeliveryCharge')?.addEventListener('change', calculateOrderTotal);

      // Make functions available globally
      window.viewOrderDetails = viewOrderDetails;
      window.updateOrderStatus = updateOrderStatus;
      window.closeModal = closeModal;
      window.logout = logout;
      window.addVariant = addVariant;
      window.addEditVariant = addEditVariant;
      window.removeVariant = removeVariant;
      window.filterMenuItems = filterMenuItems;
      window.showSection = showSection;
      window.showOrderTab = showOrderTab;
      window.showMenuTab = showMenuTab;
      window.editMenuItem = editMenuItem;
      window.editCategory = editCategory;
      window.editCustomer = editCustomer;
      window.editDeliveryPerson = editDeliveryPerson;
      window.editOrder = editOrder;
      window.deleteMenuItem = deleteMenuItem;
      window.deleteCategory = deleteCategory;
      window.deleteCustomer = deleteCustomer;
      window.deleteDeliveryStaff = deleteDeliveryStaff;
      window.deleteOrder = deleteOrder;
      window.addOrderItem = addOrderItem;
      window.removeOrderItem = removeOrderItem;
    }

    // ==================== FORM HANDLERS ====================
    async function handleAddCategory(e) {
      e.preventDefault();
      try {
        const categoryData = {
          name: document.getElementById('categoryName').value.trim(),
          icon: document.getElementById('categoryIcon').value.trim(),
          active: document.getElementById('categoryStatus').value === 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Validate inputs
        if (!categoryData.name || !categoryData.icon) {
          throw new Error('Category name and icon are required');
        }
        
        // Show loading state
        document.getElementById('add-category-btn-text').style.display = 'none';
        document.getElementById('add-category-spinner').style.display = 'inline-block';
        
        await db.collection('categories').add(categoryData);
        showNotification('success', 'Category added successfully');
        e.target.reset();
        await loadMenuData(); // Refresh categories list
        
      } catch (error) {
        console.error('Failed to add category:', error);
        showNotification('error', error.message || 'Failed to add category');
      } finally {
        document.getElementById('add-category-btn-text').style.display = 'inline';
        document.getElementById('add-category-spinner').style.display = 'none';
      }
    }

    async function handleAddMenuItem(e) {
      e.preventDefault();
      try {
        // Extract variants
        const variantElements = document.querySelectorAll('#variantContainer .variant-item');
        const variants = Array.from(variantElements).map(el => {
          const inputs = el.querySelectorAll('input');
          return {
            name: inputs[0].value.trim(),
            price: parseFloat(inputs[1].value)
          };
        });
        
        // Validate variants
        variants.forEach(variant => {
          if (!variant.name || isNaN(variant.price) || variant.price < 0) {
            throw new Error('All variants must have a name and valid price');
          }
        });
        
        const itemData = {
          name: document.getElementById('itemName').value.trim(),
          bengaliName: document.getElementById('itemNameBn').value.trim(),
          category: document.getElementById('itemCategory').value,
          description: document.getElementById('itemDescription').value.trim(),
          variants,
          active: document.getElementById('itemStatus').value === 'active',
          availableForDelivery: document.getElementById('deliveryAvailable').value === 'yes',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Validate required fields
        if (!itemData.name || !itemData.category) {
          throw new Error('Item name and category are required');
        }
        
        // Show loading state
        document.getElementById('add-item-btn-text').style.display = 'none';
        document.getElementById('add-item-spinner').style.display = 'inline-block';
        
        // Add item to Firestore
        const docRef = await db.collection('menuItems').add(itemData);
        
        // Upload image if provided
        const imageFile = document.getElementById('itemImage').files[0];
        if (imageFile) {
          const storageRef = storage.ref(`menu-items/${docRef.id}/${imageFile.name}`);
          await storageRef.put(imageFile);
          const imageUrl = await storageRef.getDownloadURL();
          await docRef.update({ imageUrl });
        }
        
        showNotification('success', 'Menu item added successfully');
        e.target.reset();
        
        // Reset variants to one default
        const container = document.getElementById('variantContainer');
        container.innerHTML = `
          <div class="variant-item">
            <input type="text" placeholder="Variant name (e.g., Small, Medium)" required>
            <input type="number" placeholder="Price" min="0" required>
            <button type="button" class="btn btn-secondary" onclick="removeVariant(this)">Remove</button>
          </div>
        `;
        
        // Reset image preview
        document.getElementById('itemImagePreview').style.display = 'none';
        document.getElementById('itemImage').value = '';
        
      } catch (error) {
        console.error('Failed to add menu item:', error);
        showNotification('error', error.message || 'Failed to add menu item');
      } finally {
        document.getElementById('add-item-btn-text').style.display = 'inline';
        document.getElementById('add-item-spinner').style.display = 'none';
      }
    }

    async function handleDeliverySettings(e) {
      e.preventDefault();
      try {
        const settings = {
          minOrderAmount: parseFloat(document.getElementById('minDeliveryOrder').value),
          maxRadius: parseFloat(document.getElementById('deliveryRadius').value),
          freeDeliveryThreshold: parseFloat(document.getElementById('freeDeliveryThreshold').value),
          charges: [
            { range: '0-4 km', amount: parseFloat(document.getElementById('deliveryCharge1').value) },
            { range: '4-6 km', amount: parseFloat(document.getElementById('deliveryCharge2').value) },
            { range: '6-8 km', amount: parseFloat(document.getElementById('deliveryCharge3').value) }
          ],
          prepTime: parseInt(document.getElementById('prepTime').value),
          travelTimePerKm: parseInt(document.getElementById('travelTimePerKm').value),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Show loading state
        document.getElementById('delivery-settings-btn-text').style.display = 'none';
        document.getElementById('delivery-settings-spinner').style.display = 'inline-block';
        
        await db.collection('settings').doc('delivery').set(settings, { merge: true });
        showNotification('success', 'Delivery settings saved successfully');
        
      } catch (error) {
        console.error('Failed to save delivery settings:', error);
        showNotification('error', 'Failed to save delivery settings');
      } finally {
        document.getElementById('delivery-settings-btn-text').style.display = 'inline';
        document.getElementById('delivery-settings-spinner').style.display = 'none';
      }
    }

    async function handleRestaurantInfo(e) {
      e.preventDefault();
      try {
        const info = {
          name: document.getElementById('restaurantName').value.trim(),
          tagline: document.getElementById('restaurantTagline').value.trim(),
          address: document.getElementById('restaurantAddress').value.trim(),
          phone: document.getElementById('restaurantPhone').value.trim(),
          email: document.getElementById('restaurantEmail').value.trim(),
          location: {
            lat: parseFloat(document.getElementById('restaurantLat').value),
            lng: parseFloat(document.getElementById('restaurantLng').value)
          },
          hours: document.getElementById('restaurantHours').value.trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Show loading state
        document.getElementById('restaurant-info-btn-text').style.display = 'none';
        document.getElementById('restaurant-info-spinner').style.display = 'inline-block';
        
        await db.collection('settings').doc('restaurant').set(info, { merge: true });
        showNotification('success', 'Restaurant information saved successfully');
        
      } catch (error) {
        console.error('Failed to save restaurant info:', error);
        showNotification('error', 'Failed to save restaurant information');
      } finally {
        document.getElementById('restaurant-info-btn-text').style.display = 'inline';
        document.getElementById('restaurant-info-spinner').style.display = 'none';
      }
    }

    async function handleAdminSettings(e) {
      e.preventDefault();
      try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        const settings = {
          name: document.getElementById('adminName').value.trim(),
          email: document.getElementById('adminEmail').value.trim(),
          phone: document.getElementById('adminPhone').value.trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Show loading state
        document.getElementById('admin-settings-btn-text').style.display = 'none';
        document.getElementById('admin-settings-spinner').style.display = 'inline-block';
        
        // Save admin info
        await db.collection('settings').doc('admin').set(settings, { merge: true });
        
        // Handle password change if provided
        if (newPassword) {
          if (newPassword !== confirmPassword) {
            throw new Error('New passwords do not match');
          }
          
          const user = auth.currentUser;
          const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            currentPassword
          );
          
          // Reauthenticate user
          await user.reauthenticateWithCredential(credential);
          
          // Update password
          await user.updatePassword(newPassword);
        }
        
        showNotification('success', 'Admin settings saved successfully');
        e.target.reset();
        
      } catch (error) {
        console.error('Failed to save admin settings:', error);
        showNotification('error', error.message || 'Failed to save admin settings');
      } finally {
        document.getElementById('admin-settings-btn-text').style.display = 'inline';
        document.getElementById('admin-settings-spinner').style.display = 'none';
      }
    }

    async function handleGenerateReport(e) {
      e.preventDefault();
      try {
        const reportType = document.getElementById('reportType').value;
        const timePeriod = document.getElementById('timePeriod').value;
        
        // Validate inputs
        if (!reportType) {
          throw new Error('Please select a report type');
        }
        
        // Show loading state
        document.getElementById('generate-report-btn-text').style.display = 'none';
        document.getElementById('generate-report-spinner').style.display = 'inline-block';
        
        // Calculate date range based on time period
        let startDate, endDate = new Date();
        
        switch (timePeriod) {
          case 'today':
            startDate = new Date();
            startDate.setHours(0, 0, 0, 0);
            break;
          case 'yesterday':
            startDate = new Date();
            startDate.setDate(startDate.getDate() - 1);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(startDate);
            endDate.setHours(23, 59, 59, 999);
            break;
          case 'week':
            startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            break;
          case 'month':
            startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 1);
            break;
          case 'quarter':
            startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 3);
            break;
          case 'year':
            startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 1);
            break;
          case 'custom':
            startDate = new Date(document.getElementById('startDate').value);
            endDate = new Date(document.getElementById('endDate').value);
            break;
          default:
            startDate = new Date(0); // All time
        }
        
        // Generate report based on type
        let reportData;
        
        switch (reportType) {
          case 'sales':
            reportData = await generateSalesReport(startDate, endDate);
            renderSalesReport(reportData);
            break;
          case 'orders':
            reportData = await generateOrdersReport(startDate, endDate);
            renderOrdersReport(reportData);
            break;
          case 'customers':
            reportData = await generateCustomersReport(startDate, endDate);
            renderCustomersReport(reportData);
            break;
          case 'items':
            reportData = await generatePopularItemsReport(startDate, endDate);
            renderPopularItemsReport(reportData);
            break;
          case 'delivery':
            reportData = await generateDeliveryPerformanceReport(startDate, endDate);
            renderDeliveryPerformanceReport(reportData);
            break;
        }
        
        showNotification('success', 'Report generated successfully');
        
      } catch (error) {
        console.error('Failed to generate report:', error);
        showNotification('error', error.message || 'Failed to generate report');
      } finally {
        document.getElementById('generate-report-btn-text').style.display = 'inline';
        document.getElementById('generate-report-spinner').style.display = 'none';
      }
    }

    // ==================== EDIT FORM HANDLERS ====================
    async function handleEditMenuItemSubmit(e) {
      e.preventDefault();
      try {
        const itemId = document.getElementById('editItemId').value;
        if (!itemId) throw new Error('No item selected');
        
        // Show loading state
        document.getElementById('update-item-btn-text').style.display = 'none';
        document.getElementById('update-item-spinner').style.display = 'inline-block';
        
        // Get form data
        const updatedData = {
          name: document.getElementById('editItemName').value.trim(),
          bengaliName: document.getElementById('editItemNameBn').value.trim(),
          category: document.getElementById('editItemCategory').value,
          description: document.getElementById('editItemDescription').value.trim(),
          active: document.getElementById('editItemStatus').value === 'active',
          availableForDelivery: document.getElementById('editDeliveryAvailable').value === 'yes',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Get variants
        const variantElements = document.querySelectorAll('#editVariantContainer .variant-item');
        updatedData.variants = Array.from(variantElements).map(el => {
          const inputs = el.querySelectorAll('input');
          return {
            name: inputs[0].value.trim(),
            price: parseFloat(inputs[1].value)
          };
        });
        
        // Validate
        if (!updatedData.name || !updatedData.category) {
          throw new Error('Name and category are required');
        }
        
        // Handle image upload if new image selected
        const imageFile = document.getElementById('editItemImage').files[0];
        if (imageFile) {
          const storageRef = storage.ref(`menu-items/${itemId}/${imageFile.name}`);
          await storageRef.put(imageFile);
          updatedData.imageUrl = await storageRef.getDownloadURL();
        }
        
        // Update in Firestore
        await db.collection('menuItems').doc(itemId).update(updatedData);
        
        showNotification('success', 'Menu item updated successfully');
        closeModal('editMenuItemModal');
        await loadMenuData();
      } catch (error) {
        console.error('Failed to update menu item:', error);
        showNotification('error', error.message || 'Failed to update menu item');
      } finally {
        document.getElementById('update-item-btn-text').style.display = 'inline';
        document.getElementById('update-item-spinner').style.display = 'none';
      }
    }

    async function handleEditCategorySubmit(e) {
      e.preventDefault();
      try {
        const categoryId = document.getElementById('editCategoryId').value;
        if (!categoryId) throw new Error('No category selected');
        
        // Show loading state
        document.getElementById('update-category-btn-text').style.display = 'none';
        document.getElementById('update-category-spinner').style.display = 'inline-block';
        
        const updatedData = {
          name: document.getElementById('editCategoryName').value.trim(),
          icon: document.getElementById('editCategoryIcon').value.trim(),
          active: document.getElementById('editCategoryStatus').value === 'active',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Validate
        if (!updatedData.name || !updatedData.icon) {
          throw new Error('Name and icon are required');
        }
        
        await db.collection('categories').doc(categoryId).update(updatedData);
        
        showNotification('success', 'Category updated successfully');
        closeModal('editCategoryModal');
        await loadMenuData();
      } catch (error) {
        console.error('Failed to update category:', error);
        showNotification('error', error.message || 'Failed to update category');
      } finally {
        document.getElementById('update-category-btn-text').style.display = 'inline';
        document.getElementById('update-category-spinner').style.display = 'none';
      }
    }

    async function handleEditCustomerSubmit(e) {
      e.preventDefault();
      try {
        const customerId = document.getElementById('editCustomerId').value;
        if (!customerId) throw new Error('No customer selected');
        
        // Show loading state
        document.getElementById('update-customer-btn-text').style.display = 'none';
        document.getElementById('update-customer-spinner').style.display = 'inline-block';
        
        const updatedData = {
          name: document.getElementById('editCustomerName').value.trim(),
          phone: document.getElementById('editCustomerPhone').value.trim(),
          email: document.getElementById('editCustomerEmail').value.trim(),
          address: document.getElementById('editCustomerAddress').value.trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Validate
        if (!updatedData.name || !updatedData.phone) {
          throw new Error('Name and phone are required');
        }
        
        await db.collection('customers').doc(customerId).update(updatedData);
        
        showNotification('success', 'Customer updated successfully');
        closeModal('editCustomerModal');
        await loadCustomersData();
      } catch (error) {
        console.error('Failed to update customer:', error);
        showNotification('error', error.message || 'Failed to update customer');
      } finally {
        document.getElementById('update-customer-btn-text').style.display = 'inline';
        document.getElementById('update-customer-spinner').style.display = 'none';
      }
    }

    async function handleEditDeliveryStaffSubmit(e) {
      e.preventDefault();
      try {
        const staffId = document.getElementById('editStaffId').value;
        if (!staffId) throw new Error('No staff selected');
        
        // Show loading state
        document.getElementById('update-staff-btn-text').style.display = 'none';
        document.getElementById('update-staff-spinner').style.display = 'inline-block';
        
        const updatedData = {
          name: document.getElementById('editStaffName').value.trim(),
          phone: document.getElementById('editStaffPhone').value.trim(),
          vehicleType: document.getElementById('editStaffVehicleType').value.trim(),
          vehicleNumber: document.getElementById('editStaffVehicleNumber').value.trim(),
          available: document.getElementById('editStaffStatus').value === 'available',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Validate
        if (!updatedData.name || !updatedData.phone || !updatedData.vehicleType || !updatedData.vehicleNumber) {
          throw new Error('All fields are required');
        }
        
        await db.collection('deliveryStaff').doc(staffId).update(updatedData);
        
        showNotification('success', 'Delivery staff updated successfully');
        closeModal('editDeliveryStaffModal');
        await loadDeliveryData();
      } catch (error) {
        console.error('Failed to update delivery staff:', error);
        showNotification('error', error.message || 'Failed to update delivery staff');
      } finally {
        document.getElementById('update-staff-btn-text').style.display = 'inline';
        document.getElementById('update-staff-spinner').style.display = 'none';
      }
    }

    async function handleEditOrderSubmit(e) {
      e.preventDefault();
      try {
        const orderId = document.getElementById('editOrderDocId').value;
        if (!orderId) throw new Error('No order selected');
        
        // Show loading state
        document.getElementById('update-order-btn-text').style.display = 'none';
        document.getElementById('update-order-spinner').style.display = 'inline-block';
        
        // Get order items
        const items = [];
        document.querySelectorAll('.order-item').forEach(item => {
          const select = item.querySelector('.order-item-select');
          const variantSelect = item.querySelector('.order-item-variant');
          const qtyInput = item.querySelector('.order-item-qty');
          const priceInput = item.querySelector('.order-item-price');
          
          if (select.value) {
            items.push({
              id: select.value,
              name: select.selectedOptions[0].text,
              variant: variantSelect.value,
              price: parseFloat(priceInput.value),
              quantity: parseInt(qtyInput.value)
            });
          }
        });
        
        if (items.length === 0) {
          throw new Error('At least one item is required');
        }
        
        // Calculate totals
        const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryCharge = parseFloat(document.getElementById('editOrderDeliveryCharge').value) || 0;
        const total = subtotal + deliveryCharge;
        
        // Prepare update data
        const updateData = {
          customerName: document.getElementById('editOrderCustomerName').value.trim(),
          customerPhone: document.getElementById('editOrderCustomerPhone').value.trim(),
          type: document.getElementById('editOrderType').value,
          status: document.getElementById('editOrderStatus').value,
          items,
          subtotal,
          deliveryCharge,
          total,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add delivery address if delivery order
        if (updateData.type === 'Delivery') {
          updateData.deliveryAddress = document.getElementById('editOrderAddress').value.trim();
        }
        
        // Update status timestamps
        if (updateData.status === 'preparing') {
          updateData.preparingAt = firebase.firestore.FieldValue.serverTimestamp();
        } else if (updateData.status === 'ready') {
          updateData.readyAt = firebase.firestore.FieldValue.serverTimestamp();
        } else if (updateData.status === 'delivered') {
          updateData.deliveredAt = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        // Update in Firestore
        await db.collection('orders').doc(orderId).update(updateData);
        
        showNotification('success', 'Order updated successfully');
        closeModal('editOrderModal');
        await loadOrdersData();
        await loadDashboardData();
      } catch (error) {
        console.error('Failed to update order:', error);
        showNotification('error', error.message || 'Failed to update order');
      } finally {
        document.getElementById('update-order-btn-text').style.display = 'inline';
        document.getElementById('update-order-spinner').style.display = 'none';
      }
    }

    // ==================== DATA LOADING ====================
    async function loadSectionData(sectionId) {
      try {
        switch (sectionId) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'orders':
            await loadOrdersData();
            break;
          case 'menu':
            await loadMenuData();
            break;
          case 'customers':
            await loadCustomersData();
            break;
          case 'delivery':
            await loadDeliveryData();
            break;
          case 'reports':
            await loadReportsData();
            break;
        }
      } catch (error) {
        console.error(`Failed to load ${sectionId} data:`, error);
        showNotification('error', `Failed to load ${sectionId} data`);
      }
    }

    async function loadDashboardData() {
      try {
        // Get today's date range
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Yesterday's date range
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        // Fetch data
        const [todayOrdersSnapshot, yesterdayOrdersSnapshot, pendingOrdersSnapshot, activeCustomersSnapshot] = await Promise.all([
          db.collection('orders').where('createdAt', '>=', today).where('createdAt', '<', tomorrow).get(),
          db.collection('orders').where('createdAt', '>=', yesterday).where('createdAt', '<', today).get(),
          db.collection('orders').where('status', '==', 'pending').get(),
          db.collection('customers').where('lastOrder', '>=', new Date(new Date().setDate(1))).get()
        ]);
        
        // Calculate today's revenue
        const todayRevenue = todayOrdersSnapshot.docs.reduce((sum, doc) => sum + (doc.data().total || 0), 0);
        
        // Calculate yesterday's revenue
        const yesterdayRevenue = yesterdayOrdersSnapshot.docs.reduce((sum, doc) => sum + (doc.data().total || 0), 0);
        
        // Calculate percentage change
        const revenueChange = yesterdayRevenue > 0 
          ? Math.round(((todayRevenue - yesterdayRevenue) / yesterdayRevenue) * 100)
          : 0;
        
        // Update dashboard cards
        document.getElementById('today-orders').textContent = todayOrdersSnapshot.size;
        document.getElementById('orders-change').textContent = 
          `${todayOrdersSnapshot.size - yesterdayOrdersSnapshot.size >= 0 ? '+' : ''}${todayOrdersSnapshot.size - yesterdayOrdersSnapshot.size} from yesterday`;
        
        document.getElementById('today-revenue').textContent = `â‚¹${todayRevenue.toLocaleString()}`;
        document.getElementById('revenue-change').textContent = 
          `${revenueChange >= 0 ? '+' : ''}${revenueChange}% from yesterday`;
        
        document.getElementById('pending-orders-count').textContent = pendingOrdersSnapshot.size;
        document.getElementById('active-customers').textContent = activeCustomersSnapshot.size;
        
        // Load recent orders
        const recentOrdersSnapshot = await db.collection('orders')
          .orderBy('createdAt', 'desc')
          .limit(10)
          .get();
        
        renderOrdersTable(recentOrdersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })), '#recent-orders');
        
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        showNotification('error', 'Failed to load dashboard data');
      }
    }

    async function loadOrdersData(tab = 'all') {
      try {
        let query;
        
        switch (tab) {
          case 'pending':
            query = db.collection('orders').where('status', '==', 'pending').orderBy('createdAt', 'desc');
            break;
          case 'preparing':
            query = db.collection('orders').where('status', '==', 'preparing').orderBy('createdAt', 'desc');
            break;
          case 'ready':
            query = db.collection('orders').where('status', '==', 'ready').orderBy('createdAt', 'desc');
            break;
          case 'delivered':
            query = db.collection('orders').where('status', '==', 'delivered').orderBy('createdAt', 'desc');
            break;
          case 'cancelled':
            query = db.collection('orders').where('status', '==', 'cancelled').orderBy('createdAt', 'desc');
            break;
          default:
            query = db.collection('orders').orderBy('createdAt', 'desc');
        }
        
        const snapshot = await query.get();
        
        switch (tab) {
          case 'pending':
            renderOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })), '#pending-orders-body');
            break;
          case 'preparing':
            renderOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })), '#preparing-orders-body');
            break;
          case 'ready':
            renderOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })), '#ready-orders-body');
            break;
          case 'delivered':
            renderOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })), '#delivered-orders-body');
            break;
          case 'cancelled':
            renderOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })), '#cancelled-orders-body');
            break;
          default:
            renderOrdersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })), '#all-orders-body');
        }
        
      } catch (error) {
        console.error('Failed to load orders data:', error);
        showNotification('error', 'Failed to load orders data');
      }
    }

    // Render orders table
    function renderOrdersTable(orders, selector) {
      const tbody = document.querySelector(selector);
      
      if (!orders || orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${selector.includes('all-orders') ? 7 : 6}" style="text-align: center;">No orders found</td></tr>`;
        return;
      }
      
      tbody.innerHTML = '';
      
      orders.forEach(order => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>#${order.id.substring(0, 8)}</td>
          <td>${order.customerName || 'N/A'}</td>
          ${selector.includes('all-orders') ? `<td>${order.type || 'N/A'}</td>` : ''}
          <td>â‚¹${order.total?.toFixed(2) || '0.00'}</td>
          ${selector.includes('all-orders') ? `<td><span class="status status-${order.status || 'pending'}">${(order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1)}</span></td>` : ''}
          <td>${order.createdAt?.toDate().toLocaleString() || 'N/A'}</td>
          <td>
            <button class="action-btn view" onclick="viewOrderDetails('${order.id}')">View</button>
            <button class="action-btn edit" onclick="editOrder('${order.id}')">Edit</button>
            ${order.status === 'cancelled' ? 
              `<button class="action-btn delete" onclick="deleteOrder('${order.id}')">Delete</button>` : ''}
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    async function loadMenuData() {
      try {
        const [categoriesSnapshot, menuItemsSnapshot] = await Promise.all([
          db.collection('categories').get(),
          db.collection('menuItems').get()
        ]);
        
        renderCategoriesTable(categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        renderMenuItemsTable(menuItemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        
        // Populate category dropdowns
        const categorySelects = [
          document.getElementById('itemCategory'),
          document.getElementById('filterCategory'),
          document.getElementById('editItemCategory')
        ];
        
        categorySelects.forEach(select => {
          if (select) {
            // Clear existing options except the first one
            while (select.options.length > 1) {
              select.remove(1);
            }
            
            // Add new options
            categoriesSnapshot.docs.forEach(doc => {
              const category = doc.data();
              if (category.active) {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = category.name;
                select.appendChild(option);
              }
            });
          }
        });
        
      } catch (error) {
        console.error('Failed to load menu data:', error);
        showNotification('error', 'Failed to load menu data');
      }
    }

    function renderCategoriesTable(categories) {
      const tbody = document.querySelector('#categories-tab table tbody');
      
      if (!categories || categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No categories found</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      categories.forEach(category => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${category.name || 'N/A'}</td>
          <td>${category.itemCount || 0}</td>
          <td><span class="status status-${category.active ? 'active' : 'inactive'}">
            ${category.active ? 'Active' : 'Inactive'}
          </span></td>
          <td>
            <button class="action-btn edit" onclick="editCategory('${category.id}')">Edit</button>
            <button class="action-btn delete" onclick="deleteCategory('${category.id}')">Delete</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // Filter menu items by category
    async function filterMenuItems() {
      const category = document.getElementById('filterCategory').value;
      try {
        let query = db.collection('menuItems');
        if (category) {
          query = query.where('category', '==', category);
        }
        
        const snapshot = await query.get();
        renderMenuItemsTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      } catch (error) {
        console.error('Failed to filter menu items:', error);
        showNotification('error', 'Failed to filter menu items');
      }
    }

    // Render menu items table
    function renderMenuItemsTable(items) {
      const tbody = document.querySelector('#items-tab table tbody');
      
      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No menu items found</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      items.forEach(item => {
        const priceRange = item.variants && item.variants.length > 1 ?
          `â‚¹${Math.min(...item.variants.map(v => v.price)).toFixed(2)} - â‚¹${Math.max(...item.variants.map(v => v.price)).toFixed(2)}` :
          item.variants && item.variants.length === 1 ? `â‚¹${item.variants[0].price.toFixed(2)}` : 'â‚¹0.00';
        
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${item.name || 'N/A'}</td>
          <td>${item.category || 'N/A'}</td>
          <td>${priceRange}</td>
          <td><span class="status status-${item.active ? 'active' : 'inactive'}">
            ${item.active ? 'Active' : 'Inactive'}
          </span></td>
          <td>
            <button class="action-btn view" onclick="viewMenuItem('${item.id}')">View</button>
            <button class="action-btn edit" onclick="editMenuItem('${item.id}')">Edit</button>
            <button class="action-btn delete" onclick="deleteMenuItem('${item.id}')">Delete</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    async function loadCustomersData() {
      try {
        const snapshot = await db.collection('customers').orderBy('lastOrder', 'desc').get();
        renderCustomersTable(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      } catch (error) {
        console.error('Failed to load customers data:', error);
        showNotification('error', 'Failed to load customers data');
      }
    }

    function renderCustomersTable(customers) {
      const tbody = document.querySelector('#customers-body');
      
      if (!customers || customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No customers found</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      customers.forEach(customer => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>
            <div style="display: flex; align-items: center;">
              <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(customer.name || 'C')}&background=random" 
                   width="30" height="30" style="border-radius: 50%; margin-right: 0.5rem;">
              ${customer.name || 'N/A'}
            </div>
          </td>
          <td>${customer.phone || 'N/A'}</td>
          <td>${customer.orderCount || 0}</td>
          <td>â‚¹${customer.totalSpent?.toFixed(2) || '0.00'}</td>
          <td>${customer.lastOrder ? customer.lastOrder.toDate().toLocaleString() : 'Never'}</td>
          <td>
            <button class="action-btn view" onclick="viewCustomer('${customer.id}')">View</button>
            <button class="action-btn edit" onclick="editCustomer('${customer.id}')">Edit</button>
            <button class="action-btn delete" onclick="deleteCustomer('${customer.id}')">Delete</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    async function loadDeliveryData() {
      try {
        const [settingsDoc, staffSnapshot] = await Promise.all([
          db.collection('settings').doc('delivery').get(),
          db.collection('deliveryStaff').get()
        ]);
        
        // Populate settings form
        if (settingsDoc.exists) {
          const settings = settingsDoc.data();
          document.getElementById('minDeliveryOrder').value = settings.minOrderAmount || 200;
          document.getElementById('deliveryRadius').value = settings.maxRadius || 8;
          document.getElementById('freeDeliveryThreshold').value = settings.freeDeliveryThreshold || 500;
          document.getElementById('deliveryCharge1').value = settings.charges?.[0]?.amount || 0;
          document.getElementById('deliveryCharge2').value = settings.charges?.[1]?.amount || 20;
          document.getElementById('deliveryCharge3').value = settings.charges?.[2]?.amount || 30;
          document.getElementById('prepTime').value = settings.prepTime || 20;
          document.getElementById('travelTimePerKm').value = settings.travelTimePerKm || 8;
        }
        
        // Render delivery staff table
        renderDeliveryStaffTable(staffSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        
      } catch (error) {
        console.error('Failed to load delivery data:', error);
        showNotification('error', 'Failed to load delivery data');
      }
    }

    function renderDeliveryStaffTable(staff) {
      const tbody = document.querySelector('#delivery-staff-body');
      
      if (!staff || staff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No delivery staff found</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      staff.forEach(person => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${person.name || 'N/A'}</td>
          <td>${person.phone || 'N/A'}</td>
          <td>${person.vehicleType || 'N/A'} (${person.vehicleNumber || 'N/A'})</td>
          <td><span class="status status-${person.available ? 'available' : 'unavailable'}">
            ${person.available ? 'Available' : 'Unavailable'}
          </span></td>
          <td>${person.currentOrder || '-'}</td>
          <td>
            <button class="action-btn view" onclick="viewDeliveryPerson('${person.id}')">View</button>
            <button class="action-btn edit" onclick="editDeliveryPerson('${person.id}')">Edit</button>
            <button class="action-btn delete" onclick="deleteDeliveryStaff('${person.id}')">Delete</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    async function loadReportsData() {
      try {
        // Generate a sample report (in a real app, you would query actual data)
        const report = {
          salesSummary: [
            { date: '2023-05-01', totalOrders: 24, totalRevenue: 5600, deliveryOrders: 15, pickupOrders: 7, dineInOrders: 2 },
            { date: '2023-05-02', totalOrders: 32, totalRevenue: 7800, deliveryOrders: 20, pickupOrders: 9, dineInOrders: 3 },
            { date: '2023-05-03', totalOrders: 28, totalRevenue: 6500, deliveryOrders: 18, pickupOrders: 8, dineInOrders: 2 },
            { date: '2023-05-04', totalOrders: 35, totalRevenue: 8200, deliveryOrders: 22, pickupOrders: 10, dineInOrders: 3 },
            { date: '2023-05-05', totalOrders: 40, totalRevenue: 9500, deliveryOrders: 25, pickupOrders: 12, dineInOrders: 3 },
            { date: '2023-05-06', totalOrders: 45, totalRevenue: 10500, deliveryOrders: 30, pickupOrders: 12, dineInOrders: 3 },
            { date: '2023-05-07', totalOrders: 38, totalRevenue: 8900, deliveryOrders: 25, pickupOrders: 10, dineInOrders: 3 }
          ],
          topItems: [
            { name: 'Margherita Pizza', category: 'Pizza', orderCount: 45, totalRevenue: 6750 },
            { name: 'Chicken Burger', category: 'Burgers', orderCount: 38, totalRevenue: 5700 },
            { name: 'Garlic Bread', category: 'Sides', orderCount: 32, totalRevenue: 2400 },
            { name: 'Chocolate Brownie', category: 'Desserts', orderCount: 28, totalRevenue: 2800 },
            { name: 'Pepsi', category: 'Beverages', orderCount: 25, totalRevenue: 1250 }
          ]
        };
        
        renderSalesReport(report);
        
      } catch (error) {
        console.error('Failed to load reports data:', error);
        showNotification('error', 'Failed to load reports data');
      }
    }

    // ==================== REPORT GENERATION ====================
    async function generateSalesReport(startDate, endDate) {
      try {
        const ordersSnapshot = await db.collection('orders')
          .where('createdAt', '>=', startDate)
          .where('createdAt', '<=', endDate)
          .get();
        
        const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Group by date
        const salesByDate = {};
        orders.forEach(order => {
          const dateStr = order.createdAt.toDate().toISOString().split('T')[0];
          if (!salesByDate[dateStr]) {
            salesByDate[dateStr] = {
              date: dateStr,
              totalOrders: 0,
              totalRevenue: 0,
              deliveryOrders: 0,
              pickupOrders: 0,
              dineInOrders: 0
            };
          }
          
          salesByDate[dateStr].totalOrders++;
          salesByDate[dateStr].totalRevenue += order.total || 0;
          
          if (order.type === 'Delivery') salesByDate[dateStr].deliveryOrders++;
          else if (order.type === 'Pickup') salesByDate[dateStr].pickupOrders++;
          else if (order.type === 'Dine In') salesByDate[dateStr].dineInOrders++;
        });
        
        return {
          salesSummary: Object.values(salesByDate).sort((a, b) => new Date(a.date) - new Date(b.date)),
          orders: orders
        };
      } catch (error) {
        console.error('Failed to generate sales report:', error);
        throw error;
      }
    }

    async function generateOrdersReport(startDate, endDate) {
      try {
        const ordersSnapshot = await db.collection('orders')
          .where('createdAt', '>=', startDate)
          .where('createdAt', '<=', endDate)
          .get();
        
        return ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Failed to generate orders report:', error);
        throw error;
      }
    }

    async function generateCustomersReport(startDate, endDate) {
      try {
        const customersSnapshot = await db.collection('customers')
          .where('lastOrder', '>=', startDate)
          .where('lastOrder', '<=', endDate)
          .get();
        
        return customersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Failed to generate customers report:', error);
        throw error;
      }
    }

    async function generatePopularItemsReport(startDate, endDate) {
      try {
        const ordersSnapshot = await db.collection('orders')
          .where('createdAt', '>=', startDate)
          .where('createdAt', '<=', endDate)
          .get();
        
        const itemsMap = {};
        
        ordersSnapshot.docs.forEach(doc => {
          const order = doc.data();
          if (order.items) {
            order.items.forEach(item => {
              if (!itemsMap[item.name]) {
                itemsMap[item.name] = {
                  name: item.name,
                  category: item.category,
                  orderCount: 0,
                  totalRevenue: 0
                };
              }
              itemsMap[item.name].orderCount++;
              itemsMap[item.name].totalRevenue += item.price || 0;
            });
          }
        });
        
        return Object.values(itemsMap).sort((a, b) => b.orderCount - a.orderCount);
      } catch (error) {
        console.error('Failed to generate popular items report:', error);
        throw error;
      }
    }

    async function generateDeliveryPerformanceReport(startDate, endDate) {
      try {
        const ordersSnapshot = await db.collection('orders')
          .where('createdAt', '>=', startDate)
          .where('createdAt', '<=', endDate)
          .where('type', '==', 'Delivery')
          .get();
        
        const staffSnapshot = await db.collection('deliveryStaff').get();
        
        const staffMap = {};
        staffSnapshot.docs.forEach(doc => {
          staffMap[doc.id] = {
            id: doc.id,
            name: doc.data().name,
            deliveryCount: 0,
            avgDeliveryTime: 0,
            totalDeliveries: 0
          };
        });
        
        let totalDeliveries = 0;
        let totalDeliveryTime = 0;
        
        ordersSnapshot.docs.forEach(doc => {
          const order = doc.data();
          if (order.deliveryPersonId && staffMap[order.deliveryPersonId]) {
            staffMap[order.deliveryPersonId].deliveryCount++;
            
            if (order.deliveredAt && order.readyAt) {
              const deliveryTime = (order.deliveredAt.toDate() - order.readyAt.toDate()) / (1000 * 60); // minutes
              staffMap[order.deliveryPersonId].avgDeliveryTime += deliveryTime;
              staffMap[order.deliveryPersonId].totalDeliveries++;
              totalDeliveryTime += deliveryTime;
              totalDeliveries++;
            }
          }
        });
        
        // Calculate averages
        Object.keys(staffMap).forEach(staffId => {
          if (staffMap[staffId].totalDeliveries > 0) {
            staffMap[staffId].avgDeliveryTime = 
              Math.round(staffMap[staffId].avgDeliveryTime / staffMap[staffId].totalDeliveries);
          }
        });
        
        const avgDeliveryTime = totalDeliveries > 0 ? Math.round(totalDeliveryTime / totalDeliveries) : 0;
        
        return {
          staffPerformance: Object.values(staffMap),
          totalDeliveries: ordersSnapshot.size,
          avgDeliveryTime: avgDeliveryTime
        };
      } catch (error) {
        console.error('Failed to generate delivery performance report:', error);
        throw error;
      }
    }

    // ==================== REPORT RENDERING ====================
    function renderSalesReport(report) {
      const salesBody = document.querySelector('#sales-summary-body');
      const topItemsBody = document.querySelector('#top-items-body');
      
      if (!report || !report.salesSummary || report.salesSummary.length === 0) {
        salesBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No sales data available</td></tr>';
        topItemsBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No items data available</td></tr>';
        return;
      }
      
      // Render sales summary
      salesBody.innerHTML = '';
      report.salesSummary.forEach(summary => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${summary.date}</td>
          <td>${summary.totalOrders}</td>
          <td>â‚¹${summary.totalRevenue.toFixed(2)}</td>
          <td>${summary.deliveryOrders}</td>
          <td>${summary.pickupOrders}</td>
          <td>${summary.dineInOrders}</td>
        `;
        salesBody.appendChild(tr);
      });
      
      // Render top items (if available)
      if (report.topItems) {
        topItemsBody.innerHTML = '';
        report.topItems.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${item.orderCount}</td>
            <td>â‚¹${item.totalRevenue.toFixed(2)}</td>
          `;
          topItemsBody.appendChild(tr);
        });
      }
    }

    function renderOrdersReport(orders) {
      const salesBody = document.querySelector('#sales-summary-body');
      salesBody.innerHTML = '';
      
      if (!orders || orders.length === 0) {
        salesBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No orders data available</td></tr>';
        return;
      }
      
      orders.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.createdAt?.toDate().toISOString().split('T')[0] || 'N/A'}</td>
          <td>#${order.id.substring(0, 8)}</td>
          <td>${order.customerName || 'N/A'}</td>
          <td>â‚¹${order.total?.toFixed(2) || '0.00'}</td>
          <td>${order.type || 'N/A'}</td>
          <td><span class="status status-${order.status || 'pending'}">${(order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1)}</span></td>
        `;
        salesBody.appendChild(tr);
      });
    }

    function renderCustomersReport(customers) {
      const salesBody = document.querySelector('#sales-summary-body');
      salesBody.innerHTML = '';
      
      if (!customers || customers.length === 0) {
        salesBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No customers data available</td></tr>';
        return;
      }
      
      customers.forEach(customer => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${customer.name || 'N/A'}</td>
          <td>${customer.phone || 'N/A'}</td>
          <td>${customer.email || 'N/A'}</td>
          <td>${customer.orderCount || 0}</td>
          <td>â‚¹${customer.totalSpent?.toFixed(2) || '0.00'}</td>
          <td>${customer.lastOrder ? customer.lastOrder.toDate().toLocaleString() : 'Never'}</td>
        `;
        salesBody.appendChild(tr);
      });
    }

    function renderPopularItemsReport(items) {
      const topItemsBody = document.querySelector('#top-items-body');
      topItemsBody.innerHTML = '';
      
      if (!items || items.length === 0) {
        topItemsBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No popular items data available</td></tr>';
        return;
      }
      
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>${item.orderCount}</td>
          <td>â‚¹${item.totalRevenue.toFixed(2)}</td>
        `;
        topItemsBody.appendChild(tr);
      });
    }

    function renderDeliveryPerformanceReport(report) {
      const salesBody = document.querySelector('#sales-summary-body');
      salesBody.innerHTML = '';
      
      if (!report || !report.staffPerformance || report.staffPerformance.length === 0) {
        salesBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No delivery performance data available</td></tr>';
        return;
      }
      
      // Add summary row
      const summaryRow = document.createElement('tr');
      summaryRow.innerHTML = `
        <td colspan="2"><strong>Overall Performance</strong></td>
        <td><strong>${report.totalDeliveries}</strong></td>
        <td><strong>${report.avgDeliveryTime} min</strong></td>
        <td colspan="2"></td>
      `;
      salesBody.appendChild(summaryRow);
      
      // Add staff rows
      report.staffPerformance.forEach(staff => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${staff.name}</td>
          <td>${staff.id.substring(0, 8)}</td>
          <td>${staff.deliveryCount}</td>
          <td>${staff.avgDeliveryTime} min</td>
          <td>
            <button class="action-btn view" onclick="viewDeliveryPerson('${staff.id}')">View</button>
          </td>
          <td></td>
        `;
        salesBody.appendChild(tr);
      });
    }

    // ==================== ORDER MANAGEMENT ====================
    async function viewOrderDetails(orderId) {
      try {
        // Show loading state
        document.getElementById('update-status-btn').disabled = true;
        document.getElementById('update-status-spinner').style.display = 'inline-block';
        
        const doc = await db.collection('orders').doc(orderId).get();
        if (!doc.exists) {
          throw new Error('Order not found');
        }
        
        const order = { id: doc.id, ...doc.data() };
        
        document.getElementById('modalOrderId').textContent = `#${order.id.substring(0, 8)}`;
        document.getElementById('modalCustomerName').textContent = order.customerName || 'N/A';
        document.getElementById('modalCustomerPhone').textContent = order.customerPhone || 'N/A';
        document.getElementById('modalOrderType').textContent = order.type || 'N/A';
        document.getElementById('modalOrderDate').textContent = order.createdAt?.toDate().toLocaleString() || 'N/A';
        
        // Set status with appropriate class
        const statusElement = document.getElementById('modalOrderStatus');
        statusElement.textContent = (order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1);
        statusElement.className = '';
        statusElement.classList.add('status', `status-${order.status || 'pending'}`);
        
        // Show/hide delivery address
        const addressContainer = document.getElementById('modalDeliveryAddressContainer');
        if (order.type === 'Delivery') {
          addressContainer.style.display = 'block';
          document.getElementById('modalDeliveryAddress').textContent = order.deliveryAddress || 'N/A';
        } else {
          addressContainer.style.display = 'none';
        }
        
        // Populate order items
        const itemsContainer = document.getElementById('modalOrderItems');
        itemsContainer.innerHTML = '';
        (order.items || []).forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.name || 'N/A'}</td>
            <td>${item.variant || 'N/A'}</td>
            <td>â‚¹${item.price?.toFixed(2) || '0.00'}</td>
          `;
          itemsContainer.appendChild(tr);
        });
        
        // Calculate totals
        const subtotal = (order.items || []).reduce((sum, item) => sum + (item.price || 0), 0);
        document.getElementById('modalOrderSubtotal').textContent = `â‚¹${subtotal.toFixed(2)}`;
        
        const deliveryRow = document.getElementById('modalDeliveryChargeRow');
        const deliveryChargeCell = document.getElementById('modalOrderDeliveryCharge');
        if (order.type === 'Delivery') {
          deliveryRow.style.display = '';
          deliveryChargeCell.textContent = order.deliveryCharge === 0 ? 'Free' : `â‚¹${order.deliveryCharge?.toFixed(2) || '0.00'}`;
        } else {
          deliveryRow.style.display = 'none';
        }
        
        document.getElementById('modalOrderTotal').textContent = 
          `â‚¹${(subtotal + (order.deliveryCharge || 0)).toFixed(2)}`;
        
        // Set current status in dropdown
        document.getElementById('updateOrderStatus').value = order.status || 'pending';
        
        // Show delivery person dropdown if order is ready for delivery
        const deliveryPersonContainer = document.getElementById('deliveryPersonContainer');
        if (order.status === 'ready' && order.type === 'Delivery') {
          deliveryPersonContainer.style.display = 'block';
          // Load delivery staff
          const staffSnapshot = await db.collection('deliveryStaff').where('available', '==', true).get();
          const select = document.getElementById('deliveryPerson');
          select.innerHTML = '<option value="">Select Delivery Person</option>';
          staffSnapshot.docs.forEach(doc => {
            const person = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = `${person.name} (${person.vehicleType} ${person.vehicleNumber})`;
            select.appendChild(option);
          });
          
          // Select current delivery person if assigned
          if (order.deliveryPersonId) {
            select.value = order.deliveryPersonId;
          }
        } else {
          deliveryPersonContainer.style.display = 'none';
        }
        
        // Show modal
        document.getElementById('orderDetailsModal').style.display = 'flex';
        
      } catch (error) {
        console.error('Failed to load order details:', error);
        showNotification('error', error.message || 'Failed to load order details');
      } finally {
        document.getElementById('update-status-btn').disabled = false;
        document.getElementById('update-status-spinner').style.display = 'none';
      }
    }

    async function updateOrderStatus() {
      const orderId = document.getElementById('modalOrderId').textContent.slice(1);
      const newStatus = document.getElementById('updateOrderStatus').value;
      const deliveryPersonId = document.getElementById('deliveryPerson').value || null;
      
      try {
        // Show loading state
        document.getElementById('update-status-btn').disabled = true;
        document.getElementById('update-status-spinner').style.display = 'inline-block';
        
        const updateData = { 
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add timestamps for status changes
        if (newStatus === 'preparing') {
          updateData.preparingAt = firebase.firestore.FieldValue.serverTimestamp();
        } else if (newStatus === 'ready') {
          updateData.readyAt = firebase.firestore.FieldValue.serverTimestamp();
        } else if (newStatus === 'delivered') {
          updateData.deliveredAt = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        if (deliveryPersonId) {
          updateData.deliveryPersonId = deliveryPersonId;
          // Mark delivery person as unavailable
          await db.collection('deliveryStaff').doc(deliveryPersonId).update({
            available: false,
            currentOrder: orderId
          });
        }
        
        await db.collection('orders').doc(orderId).update(updateData);
        showNotification('success', `Order status updated to ${newStatus}`);
        closeModal('orderDetailsModal');
        
        // Refresh orders data
        await loadOrdersData();
        await loadDashboardData();
        
      } catch (error) {
        console.error('Failed to update order status:', error);
        showNotification('error', error.message || 'Failed to update order status');
      } finally {
        document.getElementById('update-status-btn').disabled = false;
        document.getElementById('update-status-spinner').style.display = 'none';
      }
    }

    // ==================== EDIT FUNCTIONS ====================
    async function editMenuItem(itemId) {
      try {
        // Show loading state
        document.getElementById('update-item-btn-text').style.display = 'none';
        document.getElementById('update-item-spinner').style.display = 'inline-block';
        
        const doc = await db.collection('menuItems').doc(itemId).get();
        if (!doc.exists) throw new Error('Menu item not found');
        
        const item = doc.data();
        
        // Populate form
        document.getElementById('editItemId').value = itemId;
        document.getElementById('editItemName').value = item.name || '';
        document.getElementById('editItemNameBn').value = item.bengaliName || '';
        document.getElementById('editItemDescription').value = item.description || '';
        document.getElementById('editItemStatus').value = item.active ? 'active' : 'inactive';
        document.getElementById('editDeliveryAvailable').value = item.availableForDelivery ? 'yes' : 'no';
        
        // Image
        const imgElement = document.getElementById('editCurrentImage');
        if (item.imageUrl) {
          imgElement.src = item.imageUrl;
          imgElement.style.display = 'block';
        } else {
          imgElement.style.display = 'none';
        }
        
        // Variants
        const variantContainer = document.getElementById('editVariantContainer');
        variantContainer.innerHTML = '';
        if (item.variants?.length > 0) {
          item.variants.forEach(v => addEditVariant(v.name, v.price));
        } else {
          addEditVariant();
        }
        
        // Categories
        const categorySelect = document.getElementById('editItemCategory');
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        const categories = await db.collection('categories').get();
        categories.forEach(doc => {
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = doc.data().name;
          option.selected = doc.id === item.category;
          categorySelect.appendChild(option);
        });
        
        // Show modal
        document.getElementById('editMenuItemModal').style.display = 'flex';
        
      } catch (error) {
        console.error('Failed to load menu item:', error);
        showNotification('error', error.message || 'Failed to load menu item');
      } finally {
        document.getElementById('update-item-btn-text').style.display = 'inline';
        document.getElementById('update-item-spinner').style.display = 'none';
      }
    }

    async function editCategory(categoryId) {
      try {
        // Show loading state
        document.getElementById('update-category-btn-text').style.display = 'none';
        document.getElementById('update-category-spinner').style.display = 'inline-block';
        
        const doc = await db.collection('categories').doc(categoryId).get();
        if (!doc.exists) throw new Error('Category not found');
        
        const category = doc.data();
        
        // Populate form
        document.getElementById('editCategoryId').value = categoryId;
        document.getElementById('editCategoryName').value = category.name || '';
        document.getElementById('editCategoryIcon').value = category.icon || '';
        document.getElementById('editCategoryStatus').value = category.active ? 'active' : 'inactive';
        
        // Show modal
        document.getElementById('editCategoryModal').style.display = 'flex';
        
      } catch (error) {
        console.error('Failed to load category:', error);
        showNotification('error', error.message || 'Failed to load category');
      } finally {
        document.getElementById('update-category-btn-text').style.display = 'inline';
        document.getElementById('update-category-spinner').style.display = 'none';
      }
    }

    async function editCustomer(customerId) {
      try {
        // Show loading state
        document.getElementById('update-customer-btn-text').style.display = 'none';
        document.getElementById('update-customer-spinner').style.display = 'inline-block';
        
        const doc = await db.collection('customers').doc(customerId).get();
        if (!doc.exists) throw new Error('Customer not found');
        
        const customer = doc.data();
        
        // Populate form
        document.getElementById('editCustomerId').value = customerId;
        document.getElementById('editCustomerName').value = customer.name || '';
        document.getElementById('editCustomerPhone').value = customer.phone || '';
        document.getElementById('editCustomerEmail').value = customer.email || '';
        document.getElementById('editCustomerAddress').value = customer.address || '';
        
        // Show modal
        document.getElementById('editCustomerModal').style.display = 'flex';
        
      } catch (error) {
        console.error('Failed to load customer:', error);
        showNotification('error', error.message || 'Failed to load customer');
      } finally {
        document.getElementById('update-customer-btn-text').style.display = 'inline';
        document.getElementById('update-customer-spinner').style.display = 'none';
      }
    }

    async function editDeliveryPerson(staffId) {
      try {
        // Show loading state
        document.getElementById('update-staff-btn-text').style.display = 'none';
        document.getElementById('update-staff-spinner').style.display = 'inline-block';
        
        const doc = await db.collection('deliveryStaff').doc(staffId).get();
        if (!doc.exists) throw new Error('Delivery person not found');
        
        const staff = doc.data();
        
        // Populate form
        document.getElementById('editStaffId').value = staffId;
        document.getElementById('editStaffName').value = staff.name || '';
        document.getElementById('editStaffPhone').value = staff.phone || '';
        document.getElementById('editStaffVehicleType').value = staff.vehicleType || '';
        document.getElementById('editStaffVehicleNumber').value = staff.vehicleNumber || '';
        document.getElementById('editStaffStatus').value = staff.available ? 'available' : 'unavailable';
        
        // Show modal
        document.getElementById('editDeliveryStaffModal').style.display = 'flex';
        
      } catch (error) {
        console.error('Failed to load delivery person:', error);
        showNotification('error', error.message || 'Failed to load delivery person');
      } finally {
        document.getElementById('update-staff-btn-text').style.display = 'inline';
        document.getElementById('update-staff-spinner').style.display = 'none';
      }
    }

    async function editOrder(orderId) {
      try {
        // Show loading state
        document.getElementById('update-order-btn-text').style.display = 'none';
        document.getElementById('update-order-spinner').style.display = 'inline-block';
        
        const doc = await db.collection('orders').doc(orderId).get();
        if (!doc.exists) throw new Error('Order not found');
        
        const order = doc.data();
        
        // Populate form
        document.getElementById('editOrderDocId').value = orderId;
        document.getElementById('editOrderId').textContent = `#${orderId.substring(0, 8)}`;
        document.getElementById('editOrderCustomerName').value = order.customerName || '';
        document.getElementById('editOrderCustomerPhone').value = order.customerPhone || '';
        document.getElementById('editOrderType').value = order.type || 'Delivery';
        document.getElementById('editOrderAddress').value = order.deliveryAddress || '';
        document.getElementById('editOrderStatus').value = order.status || 'pending';
        document.getElementById('editOrderSubtotal').value = order.subtotal?.toFixed(2) || '0.00';
        document.getElementById('editOrderDeliveryCharge').value = order.deliveryCharge?.toFixed(2) || '0.00';
        document.getElementById('editOrderTotal').value = order.total?.toFixed(2) || '0.00';
        
        // Toggle address field based on order type
        toggleOrderAddressField();
        
        // Load order items
        const itemsContainer = document.getElementById('editOrderItemsContainer');
        itemsContainer.innerHTML = '';
        
        if (order.items?.length > 0) {
          order.items.forEach(item => addOrderItemToEditForm(item));
        } else {
          addOrderItem();
        }
        
        // Load menu items for dropdown
        await loadMenuItemsForOrderEdit();
        
        // Show modal
        document.getElementById('editOrderModal').style.display = 'flex';
        
      } catch (error) {
        console.error('Failed to load order:', error);
        showNotification('error', error.message || 'Failed to load order');
      } finally {
        document.getElementById('update-order-btn-text').style.display = 'inline';
        document.getElementById('update-order-spinner').style.display = 'none';
      }
    }

    function addOrderItemToEditForm(item) {
      const container = document.getElementById('editOrderItemsContainer');
      const div = document.createElement('div');
      div.className = 'order-item';
      div.innerHTML = `
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <select class="order-item-select" required>
              <option value="">Select Menu Item</option>
            </select>
          </div>
          <div class="form-group">
            <select class="order-item-variant">
              <option value="">Select Variant</option>
            </select>
          </div>
          <div class="form-group" style="max-width: 80px;">
            <input type="number" class="order-item-qty" min="1" value="1" required>
          </div>
          <div class="form-group" style="max-width: 100px;">
            <input type="number" class="order-item-price" min="0" step="0.01" readonly>
          </div>
          <button type="button" class="btn btn-secondary" onclick="removeOrderItem(this)">Remove</button>
        </div>
      `;
      container.appendChild(div);
      
      // If editing existing item, populate values
      if (item) {
        const select = div.querySelector('.order-item-select');
        const variantSelect = div.querySelector('.order-item-variant');
        const qtyInput = div.querySelector('.order-item-qty');
        const priceInput = div.querySelector('.order-item-price');
        
        // This would need to be populated after menu items are loaded
        setTimeout(() => {
          if (item.name) {
            const option = Array.from(select.options).find(opt => opt.text.includes(item.name));
            if (option) {
              option.selected = true;
              select.dispatchEvent(new Event('change'));
              
              // Set variant after a delay to allow variants to load
              setTimeout(() => {
                if (item.variant) {
                  const variantOption = Array.from(variantSelect.options).find(opt => opt.text.includes(item.variant));
                  if (variantOption) variantOption.selected = true;
                }
                qtyInput.value = item.quantity || 1;
                priceInput.value = item.price?.toFixed(2) || '0.00';
              }, 300);
            }
          }
        }, 500);
      }
    }

    async function loadMenuItemsForOrderEdit() {
      try {
        const snapshot = await db.collection('menuItems').where('active', '==', true).get();
        const selects = document.querySelectorAll('.order-item-select');
        
        selects.forEach(select => {
          // Clear existing options except the first one
          while (select.options.length > 1) {
            select.remove(1);
          }
          
          // Add new options
          snapshot.forEach(doc => {
            const item = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = item.name;
            option.dataset.variants = JSON.stringify(item.variants || []);
            select.appendChild(option);
          });
        });
        
        // Add event listeners for item selection
        document.querySelectorAll('.order-item-select').forEach(select => {
          select.addEventListener('change', function() {
            const variants = JSON.parse(this.selectedOptions[0]?.dataset.variants || '[]');
            const variantSelect = this.closest('.form-row').querySelector('.order-item-variant');
            
            // Clear and repopulate variants
            variantSelect.innerHTML = '<option value="">Select Variant</option>';
            variants.forEach(variant => {
              const option = document.createElement('option');
              option.value = variant.name;
              option.textContent = `${variant.name} (â‚¹${variant.price.toFixed(2)})`;
              option.dataset.price = variant.price;
              variantSelect.appendChild(option);
            });
          });
        });
        
        // Add event listeners for variant selection
        document.querySelectorAll('.order-item-variant').forEach(select => {
          select.addEventListener('change', function() {
            const priceInput = this.closest('.form-row').querySelector('.order-item-price');
            if (this.selectedOptions[0]?.dataset.price) {
              priceInput.value = parseFloat(this.selectedOptions[0].dataset.price).toFixed(2);
            } else {
              priceInput.value = '0.00';
            }
            calculateOrderSubtotal();
          });
        });
        
        // Add event listeners for quantity changes
        document.querySelectorAll('.order-item-qty').forEach(input => {
          input.addEventListener('change', calculateOrderSubtotal);
        });
        
      } catch (error) {
        console.error('Failed to load menu items:', error);
      }
    }

    function calculateOrderSubtotal() {
      let subtotal = 0;
      document.querySelectorAll('.order-item').forEach(item => {
        const price = parseFloat(item.querySelector('.order-item-price').value) || 0;
        const qty = parseInt(item.querySelector('.order-item-qty').value) || 0;
        subtotal += price * qty;
      });
      
      document.getElementById('editOrderSubtotal').value = subtotal.toFixed(2);
      calculateOrderTotal();
    }

    function calculateOrderTotal() {
      const subtotal = parseFloat(document.getElementById('editOrderSubtotal').value) || 0;
      const deliveryCharge = parseFloat(document.getElementById('editOrderDeliveryCharge').value) || 0;
      document.getElementById('editOrderTotal').value = (subtotal + deliveryCharge).toFixed(2);
    }

    function toggleOrderAddressField() {
      const type = document.getElementById('editOrderType').value;
      const addressGroup = document.getElementById('editOrderAddressGroup');
      addressGroup.style.display = type === 'Delivery' ? 'block' : 'none';
    }

    function addOrderItem() {
      const container = document.getElementById('editOrderItemsContainer');
      const div = document.createElement('div');
      div.className = 'order-item';
      div.innerHTML = `
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <select class="order-item-select" required>
              <option value="">Select Menu Item</option>
            </select>
          </div>
          <div class="form-group">
            <select class="order-item-variant">
              <option value="">Select Variant</option>
            </select>
          </div>
          <div class="form-group" style="max-width: 80px;">
            <input type="number" class="order-item-qty" min="1" value="1" required>
          </div>
          <div class="form-group" style="max-width: 100px;">
            <input type="number" class="order-item-price" min="0" step="0.01" readonly>
          </div>
          <button type="button" class="btn btn-secondary" onclick="removeOrderItem(this)">Remove</button>
        </div>
      `;
      container.appendChild(div);
      
      // Load menu items for this new select
      loadMenuItemsForOrderEdit();
    }

    function removeOrderItem(button) {
      if (document.querySelectorAll('.order-item').length > 1) {
        button.closest('.order-item').remove();
        calculateOrderSubtotal();
      } else {
        showNotification('warning', 'At least one item is required');
      }
    }

    // ==================== DELETE FUNCTIONS ====================
    async function deleteMenuItem(itemId) {
      try {
        if (confirm('Are you sure you want to delete this menu item?')) {
          // Show loading state
          showLoading('delete-item');
          
          // Check if item is in any orders
          const ordersSnapshot = await db.collection('orders')
            .where('items', 'array-contains', { id: itemId })
            .limit(1)
            .get();
          
          if (!ordersSnapshot.empty) {
            throw new Error('Cannot delete menu item that is part of existing orders');
          }
          
          await db.collection('menuItems').doc(itemId).delete();
          showNotification('success', 'Menu item deleted successfully');
          
          // Refresh menu data
          await loadMenuData();
        }
      } catch (error) {
        console.error('Failed to delete menu item:', error);
        showNotification('error', error.message || 'Failed to delete menu item');
      } finally {
        hideLoading('delete-item');
      }
    }

    async function deleteCategory(categoryId) {
      try {
        if (confirm('Are you sure you want to delete this category?')) {
          // Show loading state
          showLoading('delete-category');
          
          // Check if category has items
          const itemsSnapshot = await db.collection('menuItems')
            .where('category', '==', categoryId).limit(1).get();
          
          if (!itemsSnapshot.empty) {
            throw new Error('Cannot delete category that has menu items assigned to it');
          }
          
          await db.collection('categories').doc(categoryId).delete();
          showNotification('success', 'Category deleted successfully');
          
          // Refresh menu data
          await loadMenuData();
        }
      } catch (error) {
        console.error('Failed to delete category:', error);
        showNotification('error', error.message || 'Failed to delete category');
      } finally {
        hideLoading('delete-category');
      }
    }

    async function deleteCustomer(customerId) {
      try {
        if (confirm('Are you sure you want to delete this customer?')) {
          // Show loading state
          showLoading('delete-customer');
          
          // Check if customer has orders
          const ordersSnapshot = await db.collection('orders')
            .where('customerId', '==', customerId)
            .limit(1)
            .get();
          
          if (!ordersSnapshot.empty) {
            throw new Error('Cannot delete customer that has existing orders');
          }
          
          await db.collection('customers').doc(customerId).delete();
          showNotification('success', 'Customer deleted successfully');
          
          // Refresh customers data
          await loadCustomersData();
        }
      } catch (error) {
        console.error('Failed to delete customer:', error);
        showNotification('error', error.message || 'Failed to delete customer');
      } finally {
        hideLoading('delete-customer');
      }
    }

    async function deleteDeliveryStaff(staffId) {
      try {
        if (confirm('Are you sure you want to delete this delivery staff member?')) {
          // Show loading state
          showLoading('delete-staff');
          
          // Check if staff is assigned to any orders
          const ordersSnapshot = await db.collection('orders')
            .where('deliveryPersonId', '==', staffId)
            .where('status', 'in', ['preparing', 'ready'])
            .limit(1)
            .get();
          
          if (!ordersSnapshot.empty) {
            throw new Error('Cannot delete delivery staff assigned to active orders');
          }
          
          await db.collection('deliveryStaff').doc(staffId).delete();
          showNotification('success', 'Delivery staff deleted successfully');
          
          // Refresh delivery data
          await loadDeliveryData();
        }
      } catch (error) {
        console.error('Failed to delete delivery staff:', error);
        showNotification('error', error.message || 'Failed to delete delivery staff');
      } finally {
        hideLoading('delete-staff');
      }
    }

    async function deleteOrder(orderId) {
      try {
        if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
          // Show loading state
          showLoading('delete-order');
          
          await db.collection('orders').doc(orderId).delete();
          showNotification('success', 'Order deleted successfully');
          
          // Refresh orders data
          await loadOrdersData();
          await loadDashboardData();
        }
      } catch (error) {
        console.error('Failed to delete order:', error);
        showNotification('error', error.message || 'Failed to delete order');
      } finally {
        hideLoading('delete-order');
      }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showLoading(context) {
      // This is a placeholder - you would implement actual loading states
      console.log(`Loading for ${context}`);
    }

    function hideLoading(context) {
      // This is a placeholder - you would implement actual loading states
      console.log(`Finished loading for ${context}`);
    }

    // Initialize the admin panel when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeAdminPanel();
    });
  </script>
</body>
</html>